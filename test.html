<%@ page language="java" pageEncoding="UTF-8" 
	import="java.util.*"
	import="com.ivo.web.*" 
	import="com.ivo.web.control.*"
	import="com.ivo.web.action.ec.*" 
	import="com.ivo.domain.hr.*" 
	import="com.ivo.domain.*" 
	import="com.ivo.domain.sys.*"
	import="com.ivo.domain.ec.*"
	import="com.ivo.system.*" 
	import="com.ivo.system.util.*"
	import="com.ivo.web.service.ec.*"  
%>
<jsp:directive.page import="com.ivo.domain.hr.Employee" />
<jsp:directive.page import="com.ivo.domain.hr.Department" />
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<%@ include file="../initiate.jsp"%>

<%
	EngineeringChangeExaminationService service = new EngineeringChangeExaminationService();
	
	EngineeringChangeExaminationAction objAction = (EngineeringChangeExaminationAction)WebDispatcher.createAction( application, request, response, "EC.ECE" );
	if( objAction == null ) return; 
	EngineeringChangeExamination objOrder = objAction.getOrderCore();
	request.setAttribute( "objOrder", objOrder );

	OrderMaster objOrderMaster = objAction.getOrderMaster();
	request.setAttribute( "objOrderMaster", objOrderMaster );
	
	if( objOrder == null ) throw new DomainException( "Order instance cannot be found. " );
	
	//ArrayList<EngineeringChangeExaminationItem> engineeringChangeExaminationItems = null;
	EngineeringChangeExaminationItem objEngineeringChangeExaminationItemLast = null;
	//engineeringChangeExaminationItems = objOrder.getEngineeringChangeExaminationItemAll();
	//if( engineeringChangeExaminationItems.size() >0 )
	//{
		//objEngineeringChangeExaminationItemLast = engineeringChangeExaminationItems.get(0);
	//}
	objEngineeringChangeExaminationItemLast = objOrder.getEngineeringChangeExaminationItemLast();
	
	HtmlImageButton objButton = null; 
	String strCalendarBind = "onmousedown=\"CalendarTime_bind(this);\" ";
	String strDelegater = "";
	boolean bDelegateFlag = false;
	ApprovalRecord objApprovalRecord = ApprovalRecord.getInstanceByOrderHandler(objOrderMaster.getTrackingNumber(),objAction.getUser().getEmployee_FK());
	int nOrderTask;
	
	if (objApprovalRecord != null) {
		nOrderTask = objAction.parseOrderTask(objApprovalRecord.getOrderTask_FK());
		strDelegater = objApprovalRecord.getDelegate_FK();
		if( !strDelegater.equals("") ){
			if( !strDelegater.equals(objAction.getUser().getEmployee_FK() ) )bDelegateFlag = true;
		}
	} else
	nOrderTask = objAction.parseOrderTask(objOrderMaster.getOrderTask_FK());

	String strReCosignDept;
	String strReCosignDeptName;
	if(objAction.getUser().getEmployee().getDepartment().getDeptLevel()<7) {
		strReCosignDept = objAction.getUser().getEmployee().getDepartment_FK();
		strReCosignDeptName = objAction.getUser().getEmployee().getDepartment().getDepartmentName();
	} else {
		if(objAction.getUser().getEmployee().getDepartment().getParentDepartment().getDeptLevel()<7) {
			strReCosignDept = objAction.getUser().getEmployee().getDepartment().getParent_FK();
			strReCosignDeptName = objAction.getUser().getEmployee().getDepartment().getParentDepartment().getDepartmentName();
		} else {
			strReCosignDept = objAction.getUser().getEmployee().getDepartment().getParentDepartment().getParent_FK();
			strReCosignDeptName = objAction.getUser().getEmployee().getDepartment().getParentDepartment().getParentDepartment().getDepartmentName();
		}
	}

	String strMemo = OrderTask.getInstance(objOrderMaster.getOrderTask_FK()).getMemo();

	boolean bHasToken = objAction.hasToken();
    boolean bMasterReadOnly = !((nOrderTask <= objAction.TASK_Adapting) && bHasToken); 
    boolean bSubmit = (( nOrderTask == objAction.TASK_Drafting
                    || nOrderTask == objAction.TASK_Adapting
                    || nOrderTask == 30
                    || nOrderTask == 150
                    || (objApprovalRecord != null && objApprovalRecord.getOrderTask_FK().equals("TMP130"))
                    || nOrderTask == objAction.TASK_VerifyOrderAdding
                    || nOrderTask == objAction.TASK_ManagerReviewing
                    || ((nOrderTask == objAction.TASK_OrderExcutinig) && ( objAction.getBooleanSubmit( objAction.getUser().getEmployee_FK(),"ECE130" ) ) )
                    || nOrderTask == objAction.TASK_Confirming
                    || nOrderTask == objAction.TASK_QRAConfirming
                    || nOrderTask == objAction.TASK_AdminConfirming
                    || objOrderMaster.getOrderTask_FK().equals("ECE150")
                    || ((nOrderTask == objAction.TASK_CustomerFeedBacking) &&(objAction.getBooleanSubmit( objAction.getUser().getEmployee_FK(),"ECE160") ) )
                    || nOrderTask == objAction.TASK_AbolishReviewing
                    || nOrderTask == objAction.TASK_InnerReviewing
                    || nOrderTask == objAction.TASK_Abolishing
                    || nOrderTask == objAction.TASK_Cosigning) && bHasToken);
                    
    boolean bReject =(( 
                     nOrderTask == objAction.TASK_ManagerReviewing
                    || nOrderTask == objAction.TASK_Confirming
                    || nOrderTask == 150
                    || (objApprovalRecord != null && objApprovalRecord.getOrderTask_FK().equals("TMP130"))
                    || nOrderTask == objAction.TASK_QRAConfirming
                    || nOrderTask == objAction.TASK_AdminConfirming
                    || objOrderMaster.getOrderTask_FK().equals("ECE150")
                    || nOrderTask == objAction.TASK_AbolishReviewing
                    || nOrderTask == objAction.TASK_Cosigning
                    || nOrderTask == objAction.TASK_InnerReviewing) && bHasToken);
                    
    boolean bReCosign =(( 
                     nOrderTask == objAction.TASK_VerifyOrderAdding
                    || nOrderTask == objAction.TASK_ManagerReviewing
                    || nOrderTask == objAction.TASK_Confirming
                    || nOrderTask == 30
                    || nOrderTask == 150
                    || nOrderTask == objAction.TASK_QRAConfirming
                    || nOrderTask == objAction.TASK_AdminConfirming
                    || objOrderMaster.getOrderTask_FK().equals("ECE150")
                    || ((nOrderTask == objAction.TASK_CustomerFeedBacking)&&(objAction.getBooleanSubmit( objAction.getUser().getEmployee_FK(),"ECE160")))
                    || nOrderTask == objAction.TASK_AbolishReviewing
                    || nOrderTask == objAction.TASK_Cosigning
                    || nOrderTask == objAction.TASK_Abolishing
                    || nOrderTask == objAction.TASK_InnerReviewing) && bHasToken);

    boolean bConfirmMaster = (nOrderTask == objAction.TASK_OrderExcutinig) && ( objAction.getBooleanSubmit( objAction.getUser().getEmployee_FK(),"ECE130") );
    boolean bFeedBackConfirm = (nOrderTask == objAction.TASK_CustomerFeedBacking) && ( objAction.getBooleanSubmit( objAction.getUser().getEmployee_FK(),"ECE160"));
    boolean bPrint = objAction.getPrintAuthor();
    boolean bSucFlag = objAction.getBooleanSucess();
    boolean bDisplay = objAction.getBooleanOfAbolishCosignDept();
%>
<html>
<head>
	<%@ include file="../include.jsp"%>
	
	<script type="text/javascript" src="./scripts/com_ivo_web_dcc.js"></script>
	<script type="text/javascript" src="./scripts/com_ivo_util.js"></script>
	<link rel="stylesheet" type="text/css" href="./ext/resources/css/ext-all.css" />
	<script type="text/javascript" src="./ext/adapter/ext/ext-base.js"></script>
	<script type="text/javascript" src="./ext/ext-all.js"></script>
	<script type="text/javascript" src="./pages/dcc/SearchField.js"></script>
	<script type="text/javascript" src="./pages/ec/Ext.ux.tree.TreeCheckNodeUI.js"></script>
	<script type="text/javascript" src="./pages/ec/RowExpander.js"></script>
	<script type="text/javascript" src="./pages/ec/EngineeringChangeExamination.js"></script>
	<script type="text/javascript" src="<%=request.getContextPath()%>/scripts/prototype.js"></script>
	<script language="javascript" src="<%=request.getContextPath()%>/scripts/buffalo.js"></script>
</head>
<!-- style Begin -->
<style type="text/css">
	.add {background-image: url(./ext/resources/images/default/dd/drop-add.gif) !important;}
	.close {background-image: url(./ext/resources/images/gray/qtip/close.gif) !important;}
	.refresh {background-image: url(./ext/resources/images/default/grid/refresh.gif) !important;}
	.submit {background-image: url(./images/dcc/agree.gif) !important;}
	.save {background-image: url(./images/dcc/save.gif) !important;}
	.delete {background-image: url(./images/dcc/rss_delete.gif) !important;}
	.print {background-image: url(./images/btn/btnPrint__b.gif) !important;}
	.upload {background-image: url(./images/btn/btnUpload__c.gif) !important;}
	.reject {background-image: url(./images/dcc/drop-no.gif) !important;}
	.agree {background-image: url(./images/btn/btnAccept__b.gif) !important;}
	.accept {background-image: url(./images/dcc/accept.png) !important;}
	.consign {background-image:url(./images/dcc/manager.gif) !important;}
	.help {background-image: url(./ext/resources/images/default/dd/help.gif) !important;}
	.STYLE1 {font-size: 12px;font-weight: bold;color: #15428B;font-family: "Arial, Simhei";}
	.STYLE2 {font-size: 22px;font-weight: bold;color: #15428B;font-family: "Arial, Simhei";}
</style>
<!-- style End -->
<!-- Script Begin -->
<script type="text/javascript" >
/* IE9下显示异常处理 */
if ((typeof Range !== "undefined") && !Range.prototype.createContextualFragment)
{
    Range.prototype.createContextualFragment = function(html)
    {
        var frag = document.createDocumentFragment(), 
        div = document.createElement("div");
        frag.appendChild(div);
        div.outerHTML = html;
        return frag;
    };
}
Ext.BLANK_IMAGE_URL = '<%=request.getContextPath()%>/ext/resources/images/default/s.gif';
ORDERPRIORITY= [<%= request.getAttribute( "orderPriorityType" ) %>];
FOLLOWUP = [<%= request.getAttribute( "followUp" ) %>];
REQUESTSTRUCTION = [<%= request.getAttribute( "instructionRequestType" ) %>];
INSTRUCTIONBOMACTION = [<%= request.getAttribute( "instructionBomAction" ) %>];
EFFECTMETHOD = [<%= request.getAttribute( "effectMethod" ) %>];
NOTICECUSTOMER = [['0','[0]未定义'],['1','[1]通知客户'], ['2','[2]不通知客户']];
BUSINESSUNIT = [<%= request.getAttribute( "businessUnit" ) %>];
FEEDBACKDEPT = [<%= request.getAttribute( "feedBackDept" ) %>];
NOTICETYPE = [<%= request.getAttribute( "noticeType" ) %>];
PDDEPT = [['1','行动装置&应用显示客户服务部'],['2','行动装置&应用显示产品应用一部'], ['3','IT&IA客户服务部'],['4','IT&IA产品应用部']];
var winAttachment = "";
var winCustomerAttachment = "";
var winAttachmentView = "";
var winVerfier = "";
var winAbolishCosign = "";
/********************begin Ext.onReady***********************/
Ext.onReady(function(){
	Ext.QuickTips.init();
	Ext.form.Field.prototype.msgTarget = 'side';
	var tab = new Tab();
	var viewport = new Ext.Viewport({title : 'viewport',id:'view',layout:'fit',width: 820,loadMask: true,height:700,items:[tab]});
	/**
	Ext.TaskMgr.start({
         interval: 5000,
         run:function(){
              var grid;
              grid = Ext.getCmp("verfyOrderGrid");
              grid.load();
         }
    });
    **/
});
/********************end Ext.onReady***********************/
/** =======================================================
 *  Tabs.js
 ** ==================================================== */
var Tab = function() {
	var showWorkFlowLog = new ShowWorkFlowLog(); 
	var showECRRelateList = new ShowECRRelateList("showECRRelateGrid");
	// var showECRConsultList = new ShowECRConsultList("showECRConsultGrid");
	var engineeringVerfierGrid = new EngineeringVerfierGrid("engineeringVerfierGrid");
	var verfyOrderGrid = new VerfyOrderGrid("verfyOrderGrid","验证指令");
	var noticeCustomerGrid = new NoticeCustomerGrid("noticeCustomerGrid","通知客户");
	var winCosign = "";
	var attachmentView = new AttachmentView("attachmentView","附件");
	var engineeringAbolishCosignGrid = new EngineeringAbolishCosignGrid("EceAbolishCosignDept");
/**************************************主体框架开始*************************************/  
	Tab.superclass.constructor.call(this, {
		title: '工程变更验证单(Engineering Change Evaluation)',
		id:'orderForm',
		labelAlign: 'right',
		buttonAlign:'right',
		bodyStyle:'padding:5px',
		labelWidth:107,
		defaults: {anchor:'100%'},
		autoScroll:true,
		items: [{
			layout:'column',
			border:false,
			items:[{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'processInstance',hidder:true,value:'<%=objOrderMaster.getProcessInstance()%>'}]
			},{columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'eceExpectDate',name:'eceExpectDate',hidder:true,value:'<%= Util.toShortDateTimeStr(objOrder.getEceExpectDate()).equals("") ? "" :(Util.toShortDateTimeStr(objOrder.getEceExpectDate())).substring(0,10)%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'taskInstance',hidder:true,value:'<%=objOrderMaster.getTaskInstance()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'actionComment',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'dateOfCreate',hidder:true,value:'<%=Util.toShortDateTimeStr(objOrderMaster.getDateOfCreate())%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'dateOfOrder',hidder:true,value:'<%=Util.toShortDateTimeStr(objOrderMaster.getDateOfOrder())%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'validFlag',hidder:true,value:'<%=objOrder.getValidFlag()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'creator',hidder:true,value:'<%=objOrderMaster.getCreator()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'updater',hidder:true,value:'<%=objOrderMaster.getUpdater()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'actionTheme',hidder:true,value:'<%=session.getAttribute("THEMENAME")%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'actionLanguage',hidder:true,value:'<%=session.getAttribute("CURRENTLANGUAGE")%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'screen_ID',hidder:true,value:'<%=objAction.getScreen().getScreen_ID()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'transition',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'opcode',hidder:true,value:'2'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'actionClose',hidder:true,value:'<%=objAction.getActionClose()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'actionView',hidder:true,value:'<%=objAction.getActionView()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'actionException',hidder:true,value:'<%=objAction.getActionException()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'employee_FK',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'employeeName',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'currentUser',hidder:true,value:'<%=objAction.getUser().getEmployee_FK()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'handOver_FK',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'handOverName',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'cosignList',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'cosign_FK',hidder:false,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'cosignName',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'otherTransits',hidder:false,value:'<%=objAction.getOtherTransits()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'orderTask_FK',hidder:false,value:'<%=objOrderMaster.getOrderTask_FK()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'notice_FK',hidder:true,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'noticeName',hidder:false,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'uploadAttachment',hidder:false,value:''}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'ecType',hidder:false,value:'ECE'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'businessUnit_FK',hidder:true,value:'<%=objOrderMaster.getBusinessUnit_FK()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'userDepartment_FK',hidder:true,value:'<%=objOrderMaster.getUserDepartment_FK()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'requisitioner_FK',hidder:true,value:'<%=objOrderMaster.getRequisitioner_FK()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'orderAction_FK',hidder:true,value:'<%=objOrderMaster.getOrderAction_FK()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'orderMaster_ID',hidder:false,value:'<%=objOrderMaster.getOrderMaster_ID()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'orderCoreName',hidder:false,value:'<%=objOrderMaster.getOrderCoreName()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'engineeringChangeExamination_ID',hidder:false,value:'<%=objOrder.getEngineeringChangeExamination_ID()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'orderFlag',hidder:false,value:'<%=objOrder.getOrderFlag()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,
				items:[{xtype:'textfield',id:'engineeringChangeExaminationItem_ID',hidder:false,value:'<%=objEngineeringChangeExaminationItemLast.getEngineeringChangeExaminationItem_ID()%>'}]
			},{
				columnWidth:.1,border:false,hidden:true,items:[{xtype:'textfield',id:'bomFlag',name:'bomFlag',hidder:true,value:'<%=objOrder.getBomFlag()%>'}]
			},{
				columnWidth:1,border:false,hidden:false,
				html:'<p align="center" class="STYLE2">工程变更验证单<br>Engineering Change Evaluation</p>'
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items: [{
					xtype:'textfield',
					fieldLabel:'签核单号',
					name:'trackingNumber',
					allowBlank: false,//不能为空
					id:'trackingNumber',
					readOnly:true,
					value:'<%=objOrderMaster.getTrackingNumber() %>',
					anchor:'70%'
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items: [{
					xtype:'textfield',
					fieldLabel:'表单状态',
					name:'orderTask',
					allowBlank: false,//不能为空
					id:'orderTask',
					readOnly:true,
					value:'[<%=objOrderMaster.getOrderTask_FK()%>]'+'<%=OrderTask.getInstance(objOrderMaster.getOrderTask_FK()).getOrderTaskName()%>',
					anchor:'70%'
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items: [{
					xtype:'textfield',
					fieldLabel:'申请人员',
					name:'requisitor',
					allowBlank: false,//不能为空
					id:'requisitor',
					readOnly:true,
					value:'[<%=objOrderMaster.getRequisitioner_FK()%>]'+'<%=Employee.getInstance(objOrderMaster.getRequisitioner_FK()).getEmployeeName()%>',
					anchor:'70%'
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items: [{
					xtype:'textfield',
					fieldLabel:'申请部门',
					name:'department',
					allowBlank: false,//不能为空
					id:'department',
					readOnly:true,
					value:'[<%=objOrderMaster.getUserDepartment_FK()%>]'+'<%=Department.getInstance(objOrderMaster.getUserDepartment_FK()).getDepartmentName()%>',
					anchor:'70%'
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items:[{
					xtype: 'combo',
					fieldLabel: '优先级别',
					emptyText:'请选择优先级别',
					valueField: 'key',
					displayField: 'value',
					hiddenName:'orderPriority_FK',
					value:'<%=objOrderMaster.getOrderPriority_FK()%>',
					editable: false,
					mode: 'local',
					allowBlank: false,//不能为空
					blankText:"不能为空，请选择",
					store:new Ext.data.SimpleStore({fields: ['key', 'value'],data : ORDERPRIORITY}),
					triggerAction:'<%=bMasterReadOnly ? "" : "all"%>',
					anchor:'70%'
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items:[{
					xtype:'numberfield',
					fieldLabel:'联系方式',
					maxLength:12,
					maxLengthText:'您输入的联系方式有误',
					allowDecimals:false,
					name:'contacts',
					allowBlank: false,//不能为空
					value:'<%=objOrderMaster.getContacts()%>',
					id:'contacts',
					readOnly:<%=bMasterReadOnly ? "true" : "false"%>,
					anchor:'70%'
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.4,layout: 'form',border:false,
				items:[{
					xtype:"datefield",
					format:"Y-m-d",
					fieldLabel: '<span style="color:red;">**</span>' + 'ECE期望完成日期',
					id : 'displayEceDateOfExpected',
					value:'<%= Util.toShortDateTimeStr(objOrder.getEceExpectDate()).equals("") ? "" :(Util.toShortDateTimeStr(objOrder.getEceExpectDate())).substring(0,10)%>',
					name: 'displayEceExpectDate',
					disabled:'<%=nOrderTask==objAction.TASK_Drafting ? "" : "all"%>',
					readOnly:true,
					allowBlank:false,
					menuListeners : {
						select: function(m, d){
							this.setValue(d); 
							Ext.get("eceExpectDate").dom.value = Ext.util.Format.date(d,"Y-m-d");
						},
						show : function(){ this.onFocus(); },
						hide : function(){ }
					},
					anchor:'70%'
				}]
			},{
				columnWidth:.5,border:false
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.9,layout: 'form',border:false,
				items:[{
					xtype: 'textfield',
					fieldLabel:'主题',
					id : 'subject',
					name: 'subject',
					value: restorestr('<%=objOrderMaster.getSubject()%>'),
					readOnly:<%=bMasterReadOnly ? "true" : "false"%>,
					allowBlank:false,
					blankText:"不能为空，请填写",	
					anchor:'86.5%',
					maxLength: 256
				}]
			},{
				columnWidth:.1,border:false
			},{
				columnWidth:.9,layout: 'form',border:false,
				items:[{
					xtype: 'textarea',
					fieldLabel:'操作提示',
					value:restorestr('<%=strMemo%>'),
					readOnly:true,
					height: 40,
					blankText:"不能为空，请填写",
					anchor:'86.2%'
				}]
			}]
		},{
			xtype:'tabpanel',
			plain:true,
			resizeTabs:false,
			activeTab: 0,//设置定位的位置
			defaults: {anchor:'87%'},
			autoHeight:true,
			border:false,
			items:[{
				title:'EC验证',
				id : 'VerifyView',
				layout:'fit',
				defaults: {anchor:'87%'},
				autoHeight:true,
				items:[{
					layout:'column',
					border:false,
					autoHeight:true,
					items:[{
						columnWidth:.1905,border:false
					},{
						columnWidth:.8095,
						layout: 'form',
						defaults: {anchor:'85%'},
						border:false,
						items:[showECRRelateList]
	/***		    },{
			            columnWidth:1,
				        border:false
				    },{
				        columnWidth:.1905,
				        border:false
			        },{
			            columnWidth:.8095,
			            layout: 'form',
			            defaults: {anchor:'85%'},
			            border:false,
			            items:[showECRConsultList]          **/
					},{
						columnWidth:1,border:false
					},{
						columnWidth:.1905,border:false
					},{
						columnWidth:.8095,layout: 'form',defaults: {anchor:'85%'},border:false,items:[engineeringVerfierGrid]
					},{
						columnWidth:1,border:false
					},{
						columnWidth:.1905,border:false
					},{
						columnWidth:.8095,layout: 'form',defaults: {anchor:'85%'},border:false,items:[verfyOrderGrid]
					},{
						columnWidth:1,border:false 
					},{
						columnWidth:.1905,border:false
					},{
						columnWidth:.8095,layout: 'form',defaults: {anchor:'85%'},border:false,
						id:"abolishFit",hidden:<%=bDisplay ? "false" : "true"%>,items:[engineeringAbolishCosignGrid]
					},{
						columnWidth:1,border:false 
					},{
						columnWidth:.1,hidden:<%=objAction.getBooleanMaterialChange() ? "false" : "true"%>,border:false
					},{
						columnWidth:.25,layout: 'form',hidden:<%=objAction.getBooleanMaterialChange() ? "false" : "true"%>,border:false,
						items:[{
							xtype: 'textfield',
							fieldLabel:'变更前料号',
							id:'beforeMaterial_FK',
							name:'beforeMaterial_FK',
							value:'<%=objEngineeringChangeExaminationItemLast.getBeforeMaterial_FK()%>',
							readOnly:true,
							anchor:'99%'
						}]
					},{
						columnWidth:.15,layout: 'form',hidden:<%=objAction.getBooleanMaterialChange() ? "false" : "true"%>,border:false,
						items: [
							new Ext.Button({ 
								text:'Get',
								hidden:<%=!bMasterReadOnly ? "false" : "true"%>,
								handler:function(){
									setSelectData("beforeMaterial_FK","material_ID","material");
								}
							})
						]
					},{
						columnWidth:.1,hidden:<%=objAction.getBooleanMaterialChange() ? "false" : "true"%>,border:false
					},{
						columnWidth:.25,layout: 'form',hidden:<%=objAction.getBooleanMaterialChange() ? "false" : "true"%>,border:false,
						items:[{
							xtype: 'textfield',fieldLabel:'变更后料号',
							id:'afterMaterial_Fk',
							name:'afterMaterial_Fk',
							value:'<%=objEngineeringChangeExaminationItemLast.getAfterMaterial_Fk()%>',
							readOnly:true,
							anchor:'99%'
						}]
					},{
						columnWidth:.15,layout: 'form',hidden:<%=objAction.getBooleanMaterialChange() ? "false" : "true"%>,border:false,
						items: [
							new Ext.Button({
								text:'Get',
								hidden:<%=!bMasterReadOnly ? "false" : "true"%>,
								handler:function(){
									setSelectData("afterMaterial_Fk","material_ID","material");
								}
							})
						]
					},{
						columnWidth:1,border:false 
					<% if( objAction.getBooleanMaterialChange() ){ %>
					},{
						columnWidth:.1,border:false
					},{
						columnWidth:.9,layout: 'form',border:false,
						items:[{
							xtype: 'textarea',
							fieldLabel:'变更前内容',
							allowBlank:false,
							id:'changeBefore',
							name:'changeBefore',
							value:restorestr('<%=objEngineeringChangeExaminationItemLast.getChangeBefore()%>'),
							readOnly:<%=bMasterReadOnly ? "true" : "false"%>,
							height: 60,
							blankText:"不能为空，请填写",
							anchor:'86.2%'
						}]
					},{
						columnWidth:.1,border:false
					},{
						columnWidth:.9,layout: 'form',border:false,
						items:[{
							xtype: 'textarea',
							fieldLabel:'变更后内容',
							allowBlank:false,
							id:'changeAfter',
							name:'changeAfter',
							value:restorestr('<%=objEngineeringChangeExaminationItemLast.getChangeAfter()%>'),
							readOnly:<%=bMasterReadOnly ? "true" : "false"%>,
							height: 60,
							blankText:"不能为空，请填写",
							anchor:'86.2%'
						}]
					<%}%>
					},{
						columnWidth:.1,border:false
					},{
						columnWidth:.9,layout: 'form',border:false,
						items:[{
							xtype: 'textarea',
							fieldLabel:'验证项目',
							allowBlank:false,
							id:'examination',
							name:'examination',
							value:restorestr('<%=objEngineeringChangeExaminationItemLast.getExamination()%>'),
							readOnly:<%=bMasterReadOnly ? "true" : "false"%>,
							height: 60,
							blankText:"不能为空，请填写",
							anchor:'86.2%'
						}]
					},{
						columnWidth:.1,border:false
					},{
						columnWidth:.45,layout: 'form',border:false,
						items:[{
							xtype: 'combo',
							<%if( (objEngineeringChangeExaminationItemLast.getCusNotifiyFlag() ==2)&& (nOrderTask == 995 || nOrderTask == 980) ) {%>
								hidden:true,
								labelSeparator:'',
							<%} else {%>
								fieldLabel:'通知客户',
								emptyText:'请选择是否通知客户',
							<%}%>
							valueField: 'key',
							displayField: 'value',
							hiddenName:'cusNotifiyFlag',
							triggerAction: '<%=(objOrderMaster.getOrderTask_FK().equals("ECE150"))&&bHasToken ? "all" : ""%>',
							value:'<%=objEngineeringChangeExaminationItemLast.getCusNotifiyFlag()%>',
							blankText:"不能为空，请选择",
							store:new Ext.data.SimpleStore({fields:['key', 'value'],data:NOTICECUSTOMER}),
							editable: false,
							mode: 'local',
							anchor:'72%',
							listeners:{
								select:function(combo,record,index) {
									if(<%=(objOrderMaster.getOrderTask_FK().equals("ECE150"))%>) {
										if(record.get('key')=='1') {
											var grid=Ext.getCmp('bcustomer_add');
											grid.show();
										} else {
											var grid=Ext.getCmp('bcustomer_add');
											grid.hide();
										}
									}
								}
							}
						}]
					},{
						columnWidth:.45,layout: 'form',border:false,
						items:[{
							xtype: 'combo',
							<%if( (objEngineeringChangeExaminationItemLast.getCusNotifiyFlag() ==2)&& (nOrderTask == 995 || nOrderTask == 980) ) {%>
								hidden:true,
								labelSeparator:'',
							<%} else {%>
								fieldLabel:'通知方式',
								emptyText:'请选择通知客户的方式',
							<%}%>
							valueField: 'key',
							displayField: 'value',
							hiddenName:'noticeType_FK',
							triggerAction: '<%=(objOrderMaster.getOrderTask_FK().equals("ECE150"))&&bHasToken ? "all" : ""%>',
							value:'<%=objEngineeringChangeExaminationItemLast.getNoticeType_FK()%>',
							blankText:"不能为空，请选择",
							store:new Ext.data.SimpleStore({fields:['key', 'value'],data:NOTICETYPE}),
							editable: false,
							mode: 'local',
							anchor:'72%'
						}]
					},{
						columnWidth:.1,border:false
					},{
						columnWidth:.45,layout: 'form',border:false,
						items:[{
							xtype: 'combo',
							<%if( objOrderMaster.getOrderTask_FK().equals("ECE145") ) {%>
								fieldLabel: '判定通知客户部门',
								emptyText:'请选择',
							<%} else {%>
								hidden:true,
								labelSeparator:'',
							<%}%>
							valueField: 'key',
							displayField: 'value',
							hiddenName:'pdDept',
							editable: false,
							mode: 'local',
							value:'4',
							blankText:"IA&IT产品应用部",
							triggerAction: 'all',
							store:new Ext.data.SimpleStore({fields: ['key', 'value'], data: PDDEPT}),
							anchor:'70%'
						}]
					},{
						columnWidth:.45,border:false
					},{
						columnWidth:.1905,border:false
					},{
						columnWidth:.8095,layout: 'form',defaults: {anchor:'85%'},border:false,items:[noticeCustomerGrid]
					}]
				}]
			}]
		},{
			layout:'column',border:false,
			items:[{
				columnWidth:1,border:false
			},{
				columnWidth:.1905,border:false
			},{
				columnWidth:.8095,layout: 'form',border:false,defaults: {anchor:'85%'},items:[attachmentView,showWorkFlowLog]
			}]
		}],
		tbar:[{
			text: '关闭',
			id : 'close',
			hidden : false,
			iconCls:'close',
			handler:function(){Toolbar_onClose();}
		},{
			text: '保存',
			id : 'save',
			hidden : <%=bMasterReadOnly ? "true" : "false"%>,
			iconCls:'save',
			handler : function() { 
			      var tabForm = Ext.getCmp("orderForm");
			      var subject = Ext.get("subject").dom.value;
                  var length = subject.length;
                //Ext.fly("beforeMaterial_FK").dom.value = "";
				//Ext.fly("afterMaterial_Fk").dom.value = "";
                  
                  if(length>256)
                  {
                     Ext.Msg.alert('温馨提示：', '您的主题字数过长，请限制在256个字符内!');
                     return ;
                  }
                   
                  if (tabForm.getForm().isValid()) 
                  {  
                     tabForm.form.submit({
	                     url : 'ecSave.do?type="ECE"',
	                     success : function()
				         {
				           window.location.reload();
				         },
	                     failure : function(form, action) 
	                     {
	                      Ext.Msg.alert('温馨提示：', '信息保存失败,请联系管理员!');
	                     },
	                     waitTitle:'请稍后',
	                     waitMsg : '正在保存数据，请稍后...'
                     });
                  } else {
                  	Ext.Msg.alert('温馨提示', '请确认红色方框里内容是否完整或正确!');
                  }         
            }
         },{
            text: '同意',
            id : 'submit',
            hidden : <%=bSubmit ? "false" : "true"%>,
			iconCls:'submit',
            handler : function() 
            {          
                var bSubmitFlag = true; 
                if(<%=(nOrderTask == objAction.TASK_Drafting || nOrderTask == objAction.TASK_Adapting) ? "true" : "false"%>) 
                {
                     var subject = Ext.get("subject").dom.value;
                     var length = subject.length;
                     if(length>256)
                     {
                          Ext.Msg.alert('温馨提示：', '您的主题字数过长，请限制在256个字符内!');
                          return ;
                     }
                   
                	 var grid=Ext.getCmp("showECRRelateGrid");
               		 var count=grid.getStore().getCount();
               		 if(count==0)
	                 {
	                     Ext.Msg.alert('温馨提示：', '您还没有选择关联的ECR单号!');
	                     return;
	                 }
	                 
	                 var verifyGrid = Ext.getCmp("engineeringVerfierGrid");
	                 var gridCount = verifyGrid.getStore().getCount();
	                 if(gridCount==0)
	                 {
	                 	 Ext.Msg.alert('温馨提示：', '您还没有选择EC验证担当者!');
	                     return;
	                 }
	                 
	                 var bResult = getBooleanMaterialChange('<%=objOrderMaster.getOrderMaster_ID()%>');
	                 if( bResult == "ok" ){
	                    var materialOfBefore = Ext.get("beforeMaterial_FK").dom.value;
	                    var materialOfAfter  = Ext.get("afterMaterial_Fk").dom.value;
	                 	if( materialOfBefore == "" || materialOfAfter == "" )
	                 	{
	                 		window.location.reload();
	                 		Ext.Msg.alert('温馨提示：', '您还没有填写变更前料号和变更后料号!');
	                 		return;
	                 	}
	                 }else{
	                 	Ext.fly("beforeMaterial_FK").dom.value = "";
	                 	Ext.fly("afterMaterial_Fk").dom.value = "";
	                 }
                }
                if(<%=(objAction.getBooleanFlag("1"))%>)
                {
                	var verifyOrderGrid = Ext.getCmp("verfyOrderGrid");
              	    var verifyOrderCount = verifyOrderGrid.getStore().getCount();
                    if( verifyOrderCount ==0 )
	                {
	                     Ext.Msg.alert('温馨提示：', '验证指令不能为空!');
	                     return;
	                }else{
	                	 var bGPFlag = false;
	                	 var bAcknowledgmentFlag = false;
	                	 var bProcurementFlag = false;
	                     for(i=0; i<verifyOrderCount;i++)
	                     {
	                     	var row = verifyOrderGrid.getStore().getAt(i);
	                     	var rowNumber = i+1;
	                     	var strCommander_FK = row.get("commander_FK");
	                     	var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
	                     	var instruction_FK = row.get("instructionTypeName");
	                     	if( strCommander_FK == loginUser )
	                     	{
	                     		 if( row.get("instructionType_FK") == "[000]未定义" || row.get("instructionDesc") == "")
	                     		 {
	                	   			 Ext.Msg.alert('温馨提示：', '请确认第'+rowNumber+'行是否选择指令类型和填写任务描述!');
	                     	 	 	 return;
	                     	 	 }else if( row.get("responsibleDeptName") == "" )
	                     	 	 {
	                     	 	      Ext.Msg.alert('温馨提示：', '请确认第'+rowNumber+'行请选择负责单位!');
	                     	          return;
	                     	 	 }else if( instruction_FK == "130" || instruction_FK == "131")
	                             {
	                             	  var result = getSubOrderByInstructionSetExamination_ID( instruction_FK ,row.get("instructionSetExamination_ID"),'<%=objOrderMaster.getTrackingNumber()%>');
			                          if(result !="ok" )
			                          {
			                          	 Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行的BOM指令还没有子指令!');
	                     	             return;
			                          }
	                             }
	                     	}

                     		if( instruction_FK == "710" ) bGPFlag = true;
                     		if( instruction_FK == "160" ) bProcurementFlag = true;
                     		if( instruction_FK == "161" ) bAcknowledgmentFlag = true;
	                     }
	                     if( !bGPFlag ){
	                     	 Ext.Msg.alert('温馨提示：', 'GP报告为必须下达的指令!');
                     	     return;
						 }
	                     if(<%=(objAction.getBooleanMaterialChange())%>)
	                     {
	                     	 var materialOfBefore = Ext.get("beforeMaterial_FK").dom.value;
	                    	 var materialOfAfter  = Ext.get("afterMaterial_Fk").dom.value;
	                    	 if( materialOfBefore != materialOfAfter)
	                    	 {          
			                     if( !bProcurementFlag ){
			                     	 Ext.Msg.alert('温馨提示：', '购规修改/发行为必须下达的指令!');
		                     	     return;
		                     	 }
			                     if( !bAcknowledgmentFlag ){
			                     	 Ext.Msg.alert('温馨提示：', '承认书修改/发行为必须下达的指令!');
		                     	     return;
			                     }
		                     }
	                     }
	                }
                 }
                //TODO 这里  提交判断
                 if(<%=bConfirmMaster ? "true" : "false"%>) 
                 {
                      var grid = Ext.getCmp("verfyOrderGrid");
                      var count = grid.getStore().getCount();
                      var flag = false;
                      for(var i=0; i<count; i++)
                      {
												abcdef = row;
                         var row = grid.getStore().getAt(i);
                         if( row.get("confirmFlag") == "0")
                         flag = true;
                      }
                      
                      if(flag == true)
                      {
                          Ext.Msg.alert('温馨提示：', '验证指令尚未得到全部确认，暂时还不能提交!');
	                      return;
                      }
                 }
                
                 if(<%=(nOrderTask == 150) ? "true" : "false"%>) 
                 {
                     var grid = Ext.getCmp("noticeCustomerGrid");
                     var count = grid.getStore().getCount();
                     var flag = Ext.get("cusNotifiyFlag").dom.value;
                     if( flag ==0)
                     {
                     	 Ext.Msg.alert('温馨提示：', '请选择是否需要通知客户!');
	                     return;
                     }else if( flag ==1 ){
                     	 if( Ext.get("noticeType_FK").dom.value == "000" ){
                     	 	Ext.Msg.alert('温馨提示：', '请选择通知客户的方式!');
	                     	return;
                     	 }
                     }else if( flag ==2 ){
                     	 if( Ext.get("noticeType_FK").dom.value != "000" ){
                     	 	Ext.Msg.alert('温馨提示：', '针对不通知客户的情况，无需选择通知客户的方式!');
	                     	return;
                     	 }
                     }
                     
                     if(count>0)
                     {
                        if( flag ==2 )
                        {
                             Ext.Msg.alert('温馨提示：', '您已填写了通知客户，请更改你的通知客户类型或删除填写的客户!');
	                     	 return;
                        }else
                        { 
                             for(var i=0; i<count;i++)
                             {
                               var row = grid.getStore().getAt(i);
                               if(row.get("customerName") =="")
                               {
                                   var rowNumber = i+1;
                                   Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有填写客户名称!');
                     	           return;  
                               }else if( row.get("positionName") =="00000")
                               {
                               	   var rowNumber = i+1;
                                   Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有选择反馈部门!');
                     	           return;  
                               }
                             }
                        }
                     }else{
                        if(flag ==1)
                        {
                             Ext.Msg.alert('温馨提示：', '您选择了通知客户，请填写您要通知的客户!');
	                     	 return;
                        }
                     }
                 }
                 
                 if(<%=(nOrderTask == objAction.TASK_CustomerFeedBacking) ? "true" : "false"%>) 
                 {
                 	 var grid = Ext.getCmp("noticeCustomerGrid");
                     var count = grid.getStore().getCount();
                     var bFlag = false;
                     var store = grid.getStore();
                     var unCosignCount = getUnCosignCount('<%=objOrderMaster.getTrackingNumber()%>',<%=nOrderTask%>);
                     if(unCosignCount > 1){
                     	Ext.Msg.alert('温馨提示：', 'ECE160阶段为签核完成不能同意!');
                     	return;
                     } else {
                     	for(var i=0;i<count;i++){
                     	
	                     	var row = grid.getStore().getAt(i);
	                     	if( row.get("followUpName") =="00" ){
	                     		 var rowNumber = i+1;
	                   	         Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行客户还没有反馈或Risk会议，暂时不能提交!');
	                     	     return;  
	                     	}
	                     	
	                     	if( row.get("followUpName") =="20" || row.get("followUpName") =="30")
	                     	{
	                     		 var rowNumber = i+1;
	                     	     if( row.get("dateOfResponse") =="")
	                     	     {
	                     	         Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有填写回执日期!');
		                     	     return;  
	                     	     }
	                     	     if( row.get("fileName") == "" )
		                   		 {					
		                   		 	 Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有客户的回执报告或是Risk Meeting会议记录!');
			               			 return;
		                   		 }
	                     	}
	                     }
                     }
                 }
                 
                 if(<%=(nOrderTask == objAction.TASK_AbolishReviewing) ? "true" : "false"%>) 
                 {
                     bSubmitFlag = false;
                 	 var grid = Ext.getCmp("EceAbolishCosignDept");
					 var count = grid.getStore().getCount();
					 if(count==0){
        				Ext.Msg.alert('温馨提示', '请添加废止所需要的会签部门！');
        				var abolishFit = Ext.getCmp("abolishFit");
           				abolishFit.show();
			     		return;
			     	 }else{
			     	 	var abolishFit = Ext.getCmp("abolishFit");
           				abolishFit.show();
           				
         				Ext.MessageBox.confirm('温馨提示', '您确定废止所需要的会签部门吗?',
						function(btn)
						{
						   if(btn == 'yes'){
                                Ext.MessageBox.show({
						           title: '意见!',
						           msg: '请您写入您宝贵的意见!',
						           width: 400,
						           buttons: Ext.MessageBox.OKCANCEL,
						           multiline: true,
						           value: "",
						           fn: submitMemo
					      		});
					       }
					       else
					          return ;
				　　　　　});
			     	 }
                 }
                 
                 if(bSubmitFlag)
                 {
	                  Ext.MessageBox.show({
				           title: '意见!',
				           msg: '请您写入您宝贵的意见!',
				           width: 400,
				           buttons: Ext.MessageBox.OKCANCEL,
				           multiline: true,
				           value: "",
				           fn: submitMemo
				      });
			      }
            }
         },{
            text: '提交1',
			hidden:<%=objAction.getBooleanFlag("2") ? "false" : "true"%>,
			iconCls:'agree',
			handler : function() 
            {      
               var grid = Ext.getCmp("verfyOrderGrid");
               var count = grid.getStore().getCount();
               var bFlag = false;
               var bFlag2 = false;
               var strMessage="";
               for(var i=0;i<count;i++)
               {
               		var record = grid.getStore().getAt(i);
               		var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
               		var delegater = '<%=strDelegater%>';
                 	var strDeptHeader_FK = record.get("responsibleDeptHeader_FK");
                 	if( loginUser == strDeptHeader_FK || (strDeptHeader_FK != "" && (strDeptHeader_FK == delegater) ) )
                 	{
                 		var rowNumber = i+1;
                 		if( record.get("responsibleName") == "")
                 		{
                 			if( record.get("resultFlag") == "0" )	bFlag2=true;
                 			bFlag = true;
                 			strMessage = '第'+rowNumber+'行指令还没有选择指令负责人!';
                 			break;
                 			//Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行指令还没有选择指令负责人!');
                 			//return;
                 		}else  if(record.get("confirmFlag") == "0")
                 		{
                 			if( record.get("resultFlag") == "0" )	bFlag2=true;
                 			bFlag = true;
                 			strMessage = '第'+rowNumber+'行指令还没有选择指令负责人!';
                 			break;
                 			//Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行指令还没有得到您的确认许可，不能提交!');
	                 		//return;
                 		}
                 	}
               }
               if( bFlag2 )Toolbar_onClose();
               else{
               		if(bFlag){
	                 	Ext.Msg.alert('温馨提示：', strMessage);
	                 	return;
	                }else{
               			openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","<%=objAction.getUser().getEmployee_FK()%>","close");
               			Toolbar_onClose();
               		}
               }
            }
         },{
        	text: '驳回',
 			hidden:<%=objAction.getBooleanFlag("2") ? "false" : "true"%>,
 			iconCls:'reject',
 			handler : function(){
 				var grid = Ext.getCmp("verfyOrderGrid");
				var record = grid.getStore().getAt(0);
				updateToDB("EC_D_InstructionSetExamination","responsibleDept_FK_1","<%=objAction.getUser().getEmployee_FK()%>","<%=objOrderMaster.getOrderMaster_ID()%>","ECECommand");
				insertApprovalRecord('<%=objOrderMaster.getOrderMaster_ID()%>',record.get('commander_FK'));
				openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","<%=objAction.getUser().getEmployee_FK()%>","close");
				Toolbar_onClose();
 			}
         },{
         	text: '提交2',
  			hidden:<%=objAction.getBooleanFlag("verifier") ? "false" : "true"%>,
  			iconCls:'agree',
  			handler : function(){
  				var grid = Ext.getCmp("verfyOrderGrid");
  				var count = grid.getStore().getCount();
  				var record = "";
  				var flag = false;
                for( var i=0; i<count;i++)
                {
                	record = grid.getStore().getAt(i);
                	var responsible = record.get('responsible_FK');
                	var dept = record.get('responsibleDept_FK');
                	// 这行的部门 不为空，   
                	if(dept!="" && responsible==""){
                		flag =true;
                		break;
                	}
                }
                if(flag){
                	insertApprovalRecordByDept('<%=objOrderMaster.getOrderMaster_ID()%>',record.get('responsibleDept_FK'));
                }
                <%-- openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","<%=objAction.getUser().getEmployee_FK()%>","close"); --%>
 				Toolbar_onClose();
  			} 
         },{
            text: '提交3',
			hidden:<%=objAction.getBooleanFlag("3") ? "false" : "true"%>,
			iconCls:'agree',
			handler : function() 
            {
            	var grid = Ext.getCmp("verfyOrderGrid");
                var count = grid.getStore().getCount();
                for( var i=0; i<count;i++)
                {
                    var record = grid.getStore().getAt(i);
                    var strResponsible_FK = record.get("responsible_FK");
                    var instruction_FK = record.get("instructionTypeName");
                    var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
                    var delegater = '<%=strDelegater%>';
                    if( strResponsible_FK == loginUser || (strResponsible_FK != "" && (strResponsible_FK == delegater) ) )
                    { 
                        if( instruction_FK == "610" )
	                    {   
	                        var rowNumber = i+1;
                            var result = getSubOrderByInstructionSetExamination_ID( instruction_FK ,record.get("instructionSetExamination_ID"),'<%=objOrderMaster.getTrackingNumber()%>');
	                        if(result !="ok" )
	                        {
	                           Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行的OnLine指令还没有子指令!');
                    	       return;
	                        }
	                    }else if( instruction_FK == "611" )
	                    {
	                    	var rowNumber = i+1;
                            var result = getSubOrderByInstructionSetExamination_ID( instruction_FK ,record.get("instructionSetExamination_ID"),'<%=objOrderMaster.getTrackingNumber()%>');
	                        if(result !="ok" )
	                        {
	                           Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行的OffLine指令还没有验证报告!');
                    	       return;
	                        }
	                    }else if( instruction_FK == "200" )
	                    {
	                    	var rowNumber = i+1;
                            var result = getSubOrderByInstructionSetExamination_ID( instruction_FK ,record.get("instructionSetExamination_ID"),'<%=objOrderMaster.getTrackingNumber()%>');
	                        if(result !="ok" )
	                        {
	                           Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行的指令请附件/图片说明变更前和变更后的差异!');
                    	       return;
	                        }
	                    }
                    
                    	if( record.get("sucessFlag") == "0")
                    	{
                         	var rowNumber = i+1;
                         	Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行指令还没有选择验证结果，请确定验证结果是否成功!');
	                     	return;
                    	}
                    	
                    	if( record.get("resultFlag") == "0")
                    	{
                         	var rowNumber = i+1;
                         	Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行指令还没有得到您的完成许可，不能提交!');
	                     	return;
                    	}
                    }
                }
                openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","<%=objAction.getUser().getEmployee_FK()%>","close");
                openOrCloseManagerApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","ECE130","<%=bDelegateFlag ? strDelegater : objAction.getUser().getEmployee_FK()%>","open");
                Toolbar_onClose();
            }
         },{
            text: '提交4',
			hidden:<%=objAction.getBooleanFlag("feedBack") ? "false" : "true"%>,
			iconCls:'agree',
			handler : function() 
            {
            	var grid = Ext.getCmp("noticeCustomerGrid");
                var count = grid.getStore().getCount();
                var userPosition = getPositions('<%=objAction.getUser().getEmployee_FK()%>').split(",");
		  
		  
                for( var i=0; i<count;i++)
                {
                	var record = grid.getStore().getAt(i);
                	
                	if(userPosition.indexOf(record.data.positionName) != -1 ){
                		
	                    if( record.get("followUpName") == "00")
	                    {
	                         var rowNumber = i+1;
	                         Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有选择处理方式!');
		                     return;
	                    }
	                    
	                   
	                    if( record.get("followUpName") =="20" || record.get("followUpName") =="30")
	                    {
	                    	 var rowNumber = i+1;
	                   	     if( record.get("dateOfResponse") =="")
	                   	     {
	                   	         Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有填写回执日期!');
	                    	     return;  
	                   	     }
	                   	     if( record.get("fileName") == "" )
	                   		 {
	                   		 	 Ext.Msg.alert('温馨提示：', '第'+rowNumber+'行还没有客户的回执报告或是Risk Meeting会议记录!');
		               			 return;
	                   		 }
	                    }
                	} else {
                		continue;
                	}
                }
                openOrCloseApprovalRecordForCustomer("<%=objOrderMaster.getOrderMaster_ID()%>","<%=objAction.getUser().getEmployee_FK()%>","close");
                Toolbar_onClose();
            }
         },{
            text:'同意执行',
            iconCls:'agree',
            hidden:<%=(nOrderTask == objAction.TASK_ManagerReviewing)&& bHasToken ? "false" : "true"%>,
            handler:function()
            {
            	 Ext.MessageBox.show({
			           title: '意见!',
			           msg: '请您写入您宝贵的意见!',
			           width: 400,
			           buttons: Ext.MessageBox.OKCANCEL,
			           multiline: true,
			           value: "",
			           fn: sendToExcute
			      });
            }    
         },{
            text: '历史',
            id:'agree',
            iconCls:'agree',
            handler:function()
            {
                openHistroy();
            } 
          },{
            text: '不同意',
            id:'notAgree',
            hidden:<%=(nOrderTask == 30)&&bHasToken ? "false" : "true"%>,
            iconCls:'reject',
            handler:function()
            {
                  Ext.MessageBox.show({
			           title: '意见!',
			           msg: '请您写入您宝贵的意见!',
			           width: 400,
			           buttons: Ext.MessageBox.OKCANCEL,
			           multiline: true,
			           value: "",
			           fn: rejectComment
			       });
            } 
         },{
            text: '驳回',
			id : 'reject',
			hidden : <%=bReject ? "false" : "true"%>,
			iconCls:'reject',
            handler : function() 
            {
                   Ext.MessageBox.show({
			           title: '意见!',
			           msg: '请您写入您宝贵的意见!',
			           width: 400,
			           buttons: Ext.MessageBox.OKCANCEL,
			           multiline: true,
			           value: "",
			           fn: rejectComment
			       });
            }
         },{
            text: '征询',
			id : 'consign',
			hidden : <%= bReCosign ? "false" : "true"%>,
			iconCls:'consign',
			handler : function() 
            {           
                 if(!winCosign)
                 {
                    winCosign = new CosignWindow();
                 }
                 winCosign.show(this); 
            }
        },{
            text: '帮助',
            id:'help',
            iconCls:'help',
            tooltip:'帮助',
            handler:function(){
          	 Ext.Msg.alert('温馨提示', '如存在问题，可与IT张鹏辉联系，分机18315');
            }
         },{
            text: '删除',
            id:'void',
            iconCls:'delete',
            hidden : <%=nOrderTask == 20 ? "false" : "true"%>,
            tooltip:'删除该申请单',
            handler : function()
            {  
                     Ext.MessageBox.confirm('温馨提示', '您确认要删除该工程变更申请单吗？',
                        function(btn)
                        {
		    　　　　      　　if(btn == 'yes')
		                  {  
		                     deleteRequisition();
		                  }else{
		                     return;
		                  }
                     });
            }
        },{
        	text: '废除',
            id:'abolish',
            iconCls:'delete',
            hidden : <%=((nOrderTask == 25)&&bHasToken || bSucFlag ) ? "false" : "true"%>,
            tooltip:'废除该申请单',
            handler : function()
            {  
            	 Ext.MessageBox.show({
			           title: '意见!',
			           msg: '请您写入您宝贵的意见!',
			           width: 400,
			           buttons: Ext.MessageBox.OKCANCEL,
			           multiline: true,
			           value: "",
			           fn: function(btn,text)
			           {
			           		if(btn == 'ok')
							{
							    if(text=='')
           						{
           							 Ext.Msg.alert('温馨提示', '请写入您宝贵意见，以供参考,谢谢！');
						     		 return;
           						}else{
           							var grid = Ext.getCmp("EceAbolishCosignDept");
           							var count = grid.getStore().getCount();
           							if(count==0){
           								 Ext.Msg.alert('温馨提示', '请添加废止所需要的会签部门！');
           								 var abolishFit = Ext.getCmp("abolishFit");
           								 abolishFit.show();
						     			 return;
           							}else{
           								 var abolishFit = Ext.getCmp("abolishFit");
           								 abolishFit.show();
           								 Ext.MessageBox.confirm('温馨提示', '您确定废止所需要的会签部门吗?',
								     　　 　　function(btn)
								           {
								    　　　　      if(btn == 'yes'){
								               	document.getElementById("actionComment").value =text;
							     				submitInformation("abolish request");	
							                  }
							                   else
							                   return ;
						　　　　　　　　　      });
							     	}
							    }  
							}else if(btn == 'cancel')
							     return;　
			           }
			      });
            }
        },{
            text:'打印',
            id:'print',
            iconCls:'print',
            hidden:<%= bPrint ? "false" : "true"%>,
            handler:function()
            {
               Toolbar_onPrint('<%=objOrderMaster.getTrackingNumber()%>');
            }
        },{
            text: '刷新',
            id:'refresh',
            iconCls:'refresh',
            hidden:false,
            handler: function()
            { 
                  window.location.reload();
            }
        }]
	});	
	
	showECRRelateList.load();
	//showECRConsultList.load();
    engineeringVerfierGrid.load();
    verfyOrderGrid.load();
	noticeCustomerGrid.load();	
	attachmentView.load();
	engineeringAbolishCosignGrid.load();
 };
 Ext.extend(Tab, Ext.FormPanel);
 /******************************主体框架结束************************************/
 /***************************************************************************/
 /** =======================================================
 *  ShowWorkFlowLog.js
 ** ==================================================== */ 

 var ShowWorkFlowLog = function() { 
	   
      var workFlowLogData = [<%=objAction.getWorkFlow()%>];
      
      this.hilite = function(v, x, record) {
		var type = record.data.deal;
		var background = record.data.lineType
		
		if (type == 1) {
			return '<span style="color:red;">' + restorestr(v) + '</span>';
		}
		else if (type == 2) {
			return '<span style="color:blue;">' + restorestr(v) + '</span>';
		}
		else if(type==3){
			return '<span style="color:olive;">' + restorestr(v) + '</span>';
		}
		
		return restorestr(v);
	};
	
	function renderName(value, metadata, record)
	{ 
	    var type = record.data.deal;
		metadata.attr = 'style="white-space:normal;"'; 
		if (type == 1) {
			return '<span style="color:red;">' + restorestr(value) + '</span>';
		}
		else if (type == 2) {
			return '<span style="color:blue;">' + restorestr(value) + '</span>';
		}else if(type == 3){
			return '<span style="color:olive;">' + restorestr(value) + '</span>';
		}
		return restorestr(value); 
	} 
	  
	  cm = new Ext.grid.ColumnModel([
		    
		    new Ext.grid.RowNumberer(),
			{header:"状态",dataIndex:"status",width:125,renderer:this.hilite,sortable:true},
			{header:"发送人",dataIndex:"sender",width:165,renderer:this.hilite,sortable:true},
			{header:"处理人",dataIndex:"hander",width:155,renderer:this.hilite,sortable:true},
			{header:"代理人",dataIndex:"attorney",width:155,renderer:this.hilite,sortable:true},
			{header:"决策",dataIndex:"transation",width:100,renderer:this.hilite,sortable:true},
			{header:"接收/送出",dataIndex:"received",width:140,renderer:this.hilite,sortable:true},
			{header:"意见",dataIndex:"comment",width:200,renderer:renderName,sortable:true}
			
	    ]);
	      
	 var ds = new Ext.data.Store({
        proxy: new Ext.data.MemoryProxy(workFlowLogData),
        reader: new Ext.data.ArrayReader({}, [
            {name: 'status'},
            {name: 'sender'},
            {name: 'hander'},
            {name: 'attorney'},
            {name: 'transation'},
            {name: 'received'},
            {name: 'comment'},
            {name: 'lineType'},
            {name: 'deal'}
        ])
       });
     ds.load();

   ShowWorkFlowLog.superclass.constructor.call(this, {
        id: 'workFlowLog',
        title:'流程日志',
        viewConfig: {forceFit: true},
        ds: ds,
        cm: cm,
        width: 850,
        autoHeight:true
    });
 }

Ext.extend(ShowWorkFlowLog, Ext.grid.GridPanel)
/************************************************************************/
/************************************************************************/
/***************************ShowECRConsultList.js*******************************/

var ShowECRConsultList=function(strGrid_ID)
{       
        this.selectECRGrid=new SelectECRGrid("selectECRConsultGrid");
        this.ecrSelectedGrid=new ECRSelectedGrid("ECRConsultSelectedGrid");
				       
        var save = function() {
            if(collectECRList=="")
            {
                Ext.Msg.alert('温馨提示：', '请选参考的ECR单号');
                return;
            }else{
                insertToDB("EC_D_RefRequest",'<%=objOrder.getEngineeringChangeExamination_ID()%>' ,collectECRList,"ECRConsultList");
                var grid=Ext.getCmp(strGrid_ID);
                grid.load();
                this.ECRListWindow.hide();
            }
        };
				   
	    var removeAll = function(){
		    collectECRList = "";
			this.ecrSelectedGrid.condition.type=collectECRList;
			this.ecrSelectedGrid.load();
	    }; 
	  
				      
        this.selectECRGrid.on({'rowdblclick':rowClickSelectECR});
	    function rowClickSelectECR(grid,rowIndex, e) {
	        var row = grid.getSelectionModel().getSelected();  
	        if(collectECRList=="")collectECRList = row.get("trackingNumber");
	        else
	        {
	           var collectECRLists=collectECRList.split(",");
	           var j=collectECRLists.length;
	           for(var i=0;i < j;i++)
			   {
			        if(collectECRLists[i]==row.get("trackingNumber"))
			        {
				          for(var t=i;t<j;t++)
				          {
				             collectECRLists[t]=collectECRLists[t+1];
				          }
				          j=j-1;
			        }
			   }
			   if(j==0)collectECRList = row.get("trackingNumber");
			   else
                           {
                           for(var m=0;m<j;m++)
                           {
                              if(m==0)collectECRList=collectECRLists[m];
                              else
                              collectECRList=collectECRList+","+collectECRLists[m];
                           
                           }
                           collectECRList = collectECRList+","+row.get("trackingNumber");
                        }
	        }
	        var selectGrid = Ext.getCmp("ECRConsultSelectedGrid");
	        selectGrid.condition.type = collectECRList;
	        selectGrid.load();
	    }
			
	/**	        
        this.ecrSelectedGrid.on({'rowdblclick':rowClickRemoveSelect});
        function rowClickRemoveSelect(grid,rowIndex, e) {
            var row = grid.getSelectionModel().getSelected(); 
	        var collectECRLists = collectECRList.split(",");
	        var j = collectECRLists.length;
	        for(var i=0;i < j;i++)
	        {
		        if(collectECRLists[i]==row.get("trackingNumber"))
		        {
			          for(var t=i;t<j;t++)
			          {
			          collectECRLists[t]=collectECRLists[t+1];
			          }
			          j=j-1;
		        }
	        }
	            if(j==0)collectECRList = "";
	            else
		        {
				     for(var m=0;m<j;m++)
				     {
				       if(m==0)collectECRList=collectECRLists[m];
				       else
				       collectECRList=collectECRList+","+collectECRLists[m];
				     }
		        } 
	            grid.condition.type = collectECRList;
	            grid.load();
	     }
		**/		        
				 
        this.ECRListPanel = new Ext.FormPanel({
	        id: 'ECRListPanel',
			region : 'center',
			width:700,
			height:550,
			layout: 'column',
			buttonAlign:'center',
			items: [{
	            columnWidth: 0.49,
	            layout: 'fit',
	            width:400,
			    height:505,
	            items:[this.selectECRGrid]
               },
	            {
	            columnWidth: 0.02,
	            width:300,
			    height:505,
	            layout: 'fit'
	           },
	            {
	        	columnWidth: 0.49,
	            width:400,
			    height:505,
	            title:'已选取的ECR',
	            layout: 'fit',
	            items:[this.ecrSelectedGrid]
	            }]  
         });         
			            
        this.showRefSheetWindow = function(){
			if (!this.ECRListWindow) {
			      this.ECRListWindow = new Ext.Window({
						id:'winECRList',
		                layout:'fit',
		                title:'ECR选择',
		                width: 800,
		                height:580,
		                closeAction:'hide',
		                plain: true,
		                closable:false,
		                buttonAlign:'center',
						items: this.ECRListPanel,
					    buttons: [{
		                    text:'确定',
		                    disabled:false,
		                    handler: save.createDelegate(this)
		                },{
		                    text:'删除所有',
		                    disabled:false,
		                    hidden:true,
		                    handler: removeAll.createDelegate(this)
		                },{
		                    text: '关闭',
		                    handler: function(){
		                    var window = Ext.getCmp("winECRList");
		                    window.hide();
		                    }
		                }]
					});	
			}

		    collectECRList = getDetailList("<%=objOrder.getEngineeringChangeExamination_ID()%>","ECRConsult");
		    this.selectECRGrid.condition.type="consult";
	        this.selectECRGrid.load({params:{start:0, limit:20}});
	        this.ecrSelectedGrid.condition.type=collectECRList;
	        this.ecrSelectedGrid.load();
	        this.ECRListWindow.show();
	    };
      
        this.condition = {}; 
        this.cm = new Ext.grid.ColumnModel([
            new Ext.grid.RowNumberer(),
			{header:"ECR编号",dataIndex:"trackingNumber",width:185,sortable:true,sortable:true},
			{header:"主题",dataIndex:"subject",width:185,sortable:true},
			{width: 25, dateIndex:'mark',renderer:renderDelete,sortable:true}
	    ]);
	    
	    function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
        {
       
         if(<%=bMasterReadOnly ? "false" : "true"%>)
           {
           	  return "<img  onclick=\"voidRequisition('"+record.data["refRequset_ID"]+"','"+strGrid_ID+"','ECRConsult');\""+
			    " src='./images/dcc/cross.gif' />";
           }else
              return ;
        }
	    
	    this.store = new Ext.data.Store({
	    baseParams: this.condition, 
        proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECRConsultSelected.do'}),
        reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'refRequset_ID'},
			{name: 'trackingNumber'},
			{name: 'subject'},
			{name:'mark'}
        ]),
        remoteSort:true 
       });    
       
	   ShowECRConsultList.superclass.constructor.call(this, {
	        id:strGrid_ID,
	        ds: this.store,
	        cm: this.cm,
	        fram:false,
	        viewConfig: {forceFit: true},
	        width: 880,
	        autoHeight:true,
	        tbar:['<h1 class ="STYLE1">ECR参考</h1>','->',{
				text: '添加',
				id : 'add',
				tooltip:'Add EngineeringChangeRequest',
				iconCls:'add',
				hidden :<%=bMasterReadOnly ? "true" : "false"%>,
				handler:this.showRefSheetWindow.createDelegate(this, [true])
			},{
			    text:'查看',
			    iconCls:'agree',
			    tooltip:'选中一行查看',
			    handler:function()
			    {
			       var grid = Ext.getCmp(strGrid_ID);
			       var row = grid.getSelectionModel().getSelected(); 
			       if(row) 
				   {
					   window.open(window.base + "/pages/ec/EngineeringChangeRequest.jsp?trackingNumber=" + row.get("trackingNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
				   }else{
				   
				       Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
				   }
			    }
		    }]
		});
};

Ext.extend(ShowECRConsultList, Ext.grid.GridPanel,{
    load:function(c)
    {
	    this.condition.engineeringChangeExamination_ID = '<%=objOrder.getEngineeringChangeExamination_ID()%>' ;
	    this.condition.type="consult";
	    this.store.load();
    },
        setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
/*************************ShowECRRelate.js*******************************/

var ShowECRRelateList=function(strGrid_ID)
{       
        this.selectECRelateGrid=new SelectECRGrid("selectECRelateGrid");
        this.ecrSelectedRelateGrid=new ECRSelectedGrid("ECRelateSelectedGrid");

        var save = function()
        {
           if(collectECRRelateList=="")
           {
               Ext.Msg.alert('温馨提示：', '请选关联的ECR单号');
               return;
           }else{
               insertToDB("EC_D_RefRequest",'<%=objOrder.getEngineeringChangeExamination_ID()%>' ,collectECRRelateList,"ECRRelateList");
               var grid=Ext.getCmp(strGrid_ID);
               grid.load();
               var verifyGrid=Ext.getCmp("engineeringVerfierGrid");
               verifyGrid.load();
               var window = Ext.getCmp("winECRRelateList");
			   window.hide();                   
           }	           
	    };
      
        var removeAll = function(){
			    collectECRRelateList = "";
				this.ecrSelectedRelateGrid.condition.type=collectECRRelateList;
				this.ecrSelectedRelateGrid.load();
		}; 
        
        this.selectECRelateGrid.on({'rowdblclick':rowClickSelectECR});
		function rowClickSelectECR(grid,rowIndex, e) 
		{
	        var row = grid.getSelectionModel().getSelected();  
	        if(collectECRRelateList=="")collectECRRelateList = row.get("trackingNumber");
	        else
	        {
	           var collectECRRelateLists=collectECRRelateList.split(",");
	           var j=collectECRRelateLists.length;
	           for(var i=0;i < j;i++)
			   {
			        if(collectECRRelateLists[i]==row.get("trackingNumber"))
			        {
				          for(var t=i;t<j;t++)
				          {
				             collectECRRelateLists[t]=collectECRRelateLists[t+1];
				          }
				          j=j-1;
			        }
			   }
			   if(j==0)collectECRRelateList = row.get("trackingNumber");
			   else
               {
                   for(var m=0;m<j;m++)
                   {
                      if(m==0)collectECRRelateList=collectECRRelateLists[m];
                      else
                      collectECRRelateList=collectECRRelateList+","+collectECRRelateLists[m];
                   
                   }
                   collectECRRelateList = collectECRRelateList+","+row.get("trackingNumber");
               }
	        }

	        var selectGrid = Ext.getCmp("ECRelateSelectedGrid");
	        selectGrid.condition.type = collectECRRelateList;
	        selectGrid.load();
	    }
        
        this.ecrSelectedRelateGrid.on({'rowdblclick':rowClickRemoveSelect});
        function rowClickRemoveSelect(grid,rowIndex, e)
        {
	        var row = grid.getSelectionModel().getSelected(); 
	        var collectECRRelateLists = collectECRRelateList.split(",");
	        var j = collectECRRelateLists.length;
	        for(var i=0;i < j;i++)
	        {
		        if(collectECRRelateLists[i]==row.get("trackingNumber"))
		        {
			          for(var t=i;t<j;t++)
			          {
			          collectECRRelateLists[t]=collectECRRelateLists[t+1];
			          }
			          j=j-1;
		        }
	        }
	        if(j==0)collectECRRelateList = "";
	        else
		    {
			    for(var m=0;m<j;m++)
			    {
			       if(m==0)collectECRRelateList=collectECRRelateLists[m];
			       else
			       collectECRRelateList=collectECRRelateList+","+collectECRRelateLists[m];
			    }
		    } 
	        grid.condition.type = collectECRRelateList;
	        grid.load();
	    }
        
         this.ECRelateListPanel = new Ext.FormPanel({
		        id: 'ECRelateListPanel',
				region : 'center',
				width:700,
				height:550,
				layout: 'column',
				buttonAlign:'center',
				items: [{
		            columnWidth: 0.49,
		            layout: 'fit',
		            width:400,
				    height:505,
		            items:[this.selectECRelateGrid]
	               },
		            {
		            columnWidth: 0.02,
		            width:300,
				    height:505,
		            layout: 'fit'
		           },
		            {
		        	columnWidth: 0.49,
		            width:400,
				    height:505,
				    layout: 'fit',
		            title:'已选取的ECR',
		            items:[this.ecrSelectedRelateGrid]
		            }]  
		 });
        
         this.showECRelateWindow = function(){
			if (!this.ECRelateListWindow) {
               this.ECRelateListWindow = new Ext.Window({
							id:'winECRRelateList',
			                layout:'fit',
			                title:'ECR选择',
			                width: 800,
			                height:580,
			                closeAction:'hide',
			                plain: true,
			                closable:false,
			                buttonAlign:'center',
							items: this.ECRelateListPanel,
						    buttons: [{
			                    text:'确定',
			                    disabled:false,
			                    handler: save.createDelegate(this)
			                },{
			                    text:'删除所有',
			                    disabled:false,
			                    hidden:true,
			                    handler: removeAll.createDelegate(this)
			                },{
			                    text: '关闭',
			                    handler: function(){
			                    var window = Ext.getCmp("winECRRelateList");
			                    window.hide();
			                    
			                    }
			                }]
			     });
			  }
			  collectECRRelateList = getDetailList("<%=objOrder.getEngineeringChangeExamination_ID()%>","ECRRelate");
			  this.selectECRelateGrid.condition.type="relate";
	          this.selectECRelateGrid.load({params:{start:0, limit:20}});
	          this.ecrSelectedRelateGrid.condition.type=collectECRRelateList;
	          this.ecrSelectedRelateGrid.load();
	          this.ECRelateListWindow.show();
		 };	
        
        this.condition = {}; 
        this.cm = new Ext.grid.ColumnModel([
            new Ext.grid.RowNumberer(),
			{header:"ECR编号",dataIndex:"trackingNumber",width:185,sortable:true,sortable:true},
			{header:"主题",dataIndex:"subject",renderer:restorestr,width:185,sortable:true},
			{width: 25, dateIndex:'mark',renderer:renderDelete,sortable:true}
	    ]);
	    
	    
	    function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
        {
       
         if(<%=bMasterReadOnly ? "false" : "true"%>)
           {
           	  return "<img  onclick=\"voidRequisition('"+record.data["refRequset_ID"]+"','"+strGrid_ID+"','ECRRelate');\""+
			    " src='./images/dcc/cross.gif' />";
           }else
              return ;
        }
	    
	    this.store = new Ext.data.Store({
	    baseParams: this.condition, 
        proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECRRelateSelected.do'}),
        reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'refRequset_ID'},
			{name: 'trackingNumber'},
			{name: 'subject'},
			{name: 'mark'}
        ]),
        remoteSort:true 
       });    
       
	   ShowECRRelateList.superclass.constructor.call(this, {
	        id:strGrid_ID,
	        ds: this.store,
	        cm: this.cm,
	        fram:false,
	        viewConfig: {forceFit: true},
	        width: 880,
	        autoHeight:true,
	        tbar:['<h1 class ="STYLE1">ECR关联</h1>','->',{
				text: '添加',
				id : 'add',
				tooltip:'Add EngineeringChangeRequest',
				iconCls:'add',
			    hidden :<%=bMasterReadOnly ? "true" : "false"%>,
				handler:this.showECRelateWindow.createDelegate(this, [true])
			},{
			    text:'查看',
			    iconCls:'agree',
			    tooltip:'选中一行查看',
			    handler:function()
			    {
			       var grid = Ext.getCmp(strGrid_ID);
			       var row = grid.getSelectionModel().getSelected(); 
			       if(row) 
				   {
					   window.open(window.base + "/pages/ec/EngineeringChangeRequest.jsp?trackingNumber=" + row.get("trackingNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
				   }else{
				   
				       Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
				   }
						    
			    }
		    }]
		});
};

Ext.extend(ShowECRRelateList, Ext.grid.GridPanel,{
    load:function()
    {
	    this.condition.engineeringChangeExamination_ID = '<%=objOrder.getEngineeringChangeExamination_ID()%>' ;
	    this.condition.type="relate";
	    this.store.load();
    }
});
/************************************************************************/
/************************************************************************/
/*************************selectECRGrid.js*******************************/

var SelectECRGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECRList.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'trackingNumber'},
            {name: 'subject'},
            {name: 'requisitioner'}
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'ECR编号', dataIndex:'trackingNumber',width:65,sortable:true},
			{header:'主题', dataIndex:'subject',renderer:restorestr,width:100},
			{header:'起草人', dataIndex:'requisitioner',width:75}
		]);
	SelectECRGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:200,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		tbar: [
            'Search: ', ' ',
            new Ext.app.SearchField({
                store: this.store,
                width:150
            })
        ],
       
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	}
	);

}

Ext.extend(SelectECRGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
/*************************ECRSelectedGrid.js*****************************/

var ECRSelectedGrid=function(strGrid_ID)
{
    this.condition = {}; 
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'ECR编号', dataIndex:'trackingNumber',width:65,sortable:true},
			{header:'主题', dataIndex:'subject',renderer:restorestr,width:100},
			{header:'起草人', dataIndex:'requisitioner',width:75}
		]);
		
	 this.store = new Ext.data.Store({
	    baseParams: this.condition, 
	    proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'SelectECR.do'}),
        reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'trackingNumber'},
            {name: 'subject'},
            {name: 'requisitioner'}
        ])
	});    

	ECRSelectedGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:300,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm
	});
};
    Ext.extend(ECRSelectedGrid, Ext.grid.GridPanel, {
		load: function(c) {
		    this.condition.documentType = "sheet";
			this.store.load();
		},
		setCondition: function(c) {
			this.condition = c;
		}
});
/************************************************************************/
/************************************************************************/
var SelectMaterialGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECEMaterialRequisitionList.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'trackingNumber'}
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'料号申请单', dataIndex:'trackingNumber',width:190,sortable:true}
		]);
	SelectMaterialGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:200,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		tbar: [
            'Search: ', ' ',
            new Ext.app.SearchField({
                store: this.store,
                width:150
            })
        ],
       
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(SelectMaterialGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
var ECEMaterialSelectedGrid=function(strGrid_ID)
{
    this.condition = {}; 
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'料号申请单', dataIndex:'trackingNumber',width:90,sortable:true}
		]);
		
	 this.store = new Ext.data.Store({
	    baseParams: this.condition, 
	    proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'selectMaterialRequisition.do'}),
        reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'trackingNumber'}
        ])
	});
		    

	ECEMaterialSelectedGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		width:300,
		height:500,
		cls: 'x-rb',
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm
	});
};
    Ext.extend(ECEMaterialSelectedGrid, Ext.grid.GridPanel, {
		load: function(c) {
		    this.condition.documentType = "sheet";
			this.store.load();
		},
		setCondition: function(c) {
			this.condition = c;
		}
});
/************************************************************************/
/************************************************************************/
var SelectOnLineGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECEOnLineList.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'trackingNumber'},
			{name: 'experimentEndReport'}
			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'实验申请单', dataIndex:'trackingNumber',width:95,sortable:true},
			{header:'结案报告', dataIndex:'experimentEndReport',width:95,sortable:true}
		]);
	SelectOnLineGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:200,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		tbar: [
            'Search: ', ' ',
            new Ext.app.SearchField({
                store: this.store,
                width:150
            })
        ],
       
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(SelectOnLineGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
var ECEOnLineSelectedGrid=function(strGrid_ID)
{
    this.condition = {}; 
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'实验申请单', dataIndex:'trackingNumber',width:90,sortable:true},
			{header:'结案报告', dataIndex:'experimentEndReport',width:95,sortable:true}
		]);
		
	 this.store = new Ext.data.Store({
	    baseParams: this.condition, 
	    proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'selectOnLine.do'}),
        reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'trackingNumber'},
			{name: 'experimentEndReport'}
        ])
	});
		    

	ECEOnLineSelectedGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		width:300,
		height:500,
		cls: 'x-rb',
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm
	});
};
    Ext.extend(ECEOnLineSelectedGrid, Ext.grid.GridPanel, {
		load: function(c) {
		    this.condition.documentType = "sheet";
			this.store.load();
		},
		setCondition: function(c) {
			this.condition = c;
		}
});
/************************************************************************/
/*************************AttachmentViewGrid.js**************************/
var AttachmentView=function(strGrid_ID,strGridBar)
{ 
      this.condition = {}; 
      this.cm = new Ext.grid.ColumnModel([
             new Ext.grid.RowNumberer(),
		     { dataIndex: 'attachment_ID',hidden:true},
             { header:"附件名称",width: 600,dataIndex: 'fileName',renderer:renderUrl,sortable:true},
             { header:"附件上传者",width: 200,dataIndex: 'ownerName',sortable:true},
             { width:50, dateIndex:'mark',renderer:renderDelete,sortable:true}
             
	  ]);
	  this.store = new Ext.data.Store({
		    baseParams: this.condition, 
	        proxy: new Ext.data.HttpProxy(
			{method: 'POST',  
			url:'ecAttachment.do'}),
	        reader: new Ext.data.JsonReader({
				 totalProperty: 'totalProperty',
				 root: 'root'
				}, [
				{name: 'attachment_ID'},
			    {name: 'attachmentBase'},
                {name: 'fileName'},
                {name: 'size'},
                {name: 'owner_FK'},
                {name: 'ownerName'},
                {name: 'name'},
                {name: 'mark'}
	        ]),
	        remoteSort:true 
      });    
	  
	  function renderMark(value) 
      {
            return "<img src='./images/dcc/math.gif' />";
      }

      function renderUrl(value, cellmeta, record, rowIndex, columnIndex, store)
     {
            return "<a href=\"" +"<%=objAction.getFileUpLoadURL()%>" + "DccProcessFileDLDownloadServlet?accessCode=" + record.data["attachmentBase"]+"&orderTask="+'<%=nOrderTask%>'+"\" target='_blank'>"+value+"</a>";
     }
     
     function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
     {
           if(<%= ( !bMasterReadOnly || objAction.getBooleanFlag("2") || objAction.getBooleanFlag("3") || ((nOrderTask == objAction.TASK_VerifyOrderAdding)&& bHasToken) || ((nOrderTask == objAction.TASK_Confirming)&& bHasToken) ) ? "true" : "false"%>)
           {
               var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
               if ( loginUser == record.data["owner_FK"] )
               {
              		 return "<img  onclick=\"deleteAttachment('"+record.data["attachment_ID"]+"','"+strGrid_ID+"');\""+
			          		" src='./images/dcc/cross.gif' />";
			   }else{
			         return;
			   }
	       }else if(<%=(nOrderTask == objAction.TASK_AdminConfirming)&&bHasToken%>){
	          	return "<img  onclick=\"deleteAttachment('"+record.data["attachment_ID"]+"','"+strGrid_ID+"');\""+
			          		" src='./images/dcc/cross.gif' />";
	       }else{
	       	 	return;
	       }
     }

   AttachmentView.superclass.constructor.call(this, {
	    id : strGrid_ID, 
		ds: this.store,
		autoHeight:true,
		viewConfig: {forceFit: true},
        cm: this.cm,
        border:true,
        tbar:['<h1 class="STYLE1">'+strGridBar+'</h1>','->',{
			text: '增加附件',
			tooltip:'增加相关的附件',
			iconCls:'add',
			hidden : <%= ( !bMasterReadOnly || objAction.getBooleanFlag("2") || objAction.getBooleanFlag("3") || ((nOrderTask == objAction.TASK_VerifyOrderAdding)&& bHasToken) || ((nOrderTask == objAction.TASK_AdminConfirming)&&bHasToken) || ((nOrderTask == objAction.TASK_Confirming)&&bHasToken) ) ? "false" : "true"%>,
			listeners:
			{
			       click:function(btnThis,eventobj)
			       { 
		                if(!winAttachmentView)
		             	{
			                 winAttachmentView = new Ext.Window({
				                layout:'fit',
				                width:500,
				                height:120,
				                closeAction:'hide',
				                plain: true,
				                items: new Ext.form.FormPanel({ 
									labelAlign: 'right', 
									id:'attachmentViewFileForm',
									labelWidth: 70, 
									frame:true, 
									fileUpload: true,
									items: [{ 
										xtype: 'textfield', 
										fieldLabel: '上传附件', 
										name: 'fileName', 
										allowBlank:false,
										inputType: 'file',
										anchor:'90%'//文件类型 
									}], 
									buttons: [{ 
										text: '上传', 
										iconCls:'upload',
										handler: function() 
										{ 
											var fileForm = Ext.getCmp("attachmentViewFileForm");
											var strAccessCode = "trackingNumber="+'<%=objOrderMaster.getTrackingNumber()%>'+"&ProcessInstance="+'<%=objOrderMaster.getProcessInstance()%>'+"&type=EC&fileKey=attachmentView&employee="+'<%=objAction.getUser().getEmployee_FK()%>';
							                if (fileForm.getForm().isValid())
							                {
							                	fileForm.form.submit({
								                     url : '<%=objAction.getFileUpLoadURL()%>' +'DccFileUploadServlet?' + strAccessCode,
								                     success : function()
								                     { 
									                     var attachGrid = Ext.getCmp(strGrid_ID);
									                     attachGrid.load();
									                     winAttachmentView.hide();
								                     },
								                     failure : function(form, action) 
								                     {
								                         Ext.Msg.alert('温馨提示：','上传失败!');
								                     },
								                     waitMsg : '正在上传，请稍后...'
								                });
							                }else{
							                
							                	Ext.Msg.alert('信息','请先选择附件!');
							                }
										}
									}]
							    })
							});  
					    }
					    
					    winAttachmentView.show(this);
		           }
		    }
		}]
   });
}
Ext.extend(AttachmentView, Ext.grid.GridPanel,{
	load: function(c) 
	{
		this.condition.type = '<%=objOrderMaster.getTrackingNumber()%>';
		this.condition.fileKey = 'attachmentView';
		this.store.load();
	}
});
/************************************************************************/
/*********************EngineeringVerfierGrid.js**************************/

var EngineeringVerfierGrid=function(strGrid_ID){
    this.condition = {}; 
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'工号', dataIndex:'employee_ID',width:487,sortable:true},
			{header:'姓名', dataIndex:'employeeName',width:487},
			{width:50, dateIndex:'mark',renderer:renderDelete,sortable:true}
		]);
		
	this.store = new Ext.data.Store({
	    baseParams: this.condition, 
	    proxy: new Ext.data.HttpProxy(
		{method: 'POST', 
		url:'verifierSelect.do'}),
        reader: new Ext.data.JsonReader({
			totalProperty: 'totalProperty',
			root: 'root',
			id:'employee_ID'
			}, [
			{name: 'refVerifier_ID'},
			{name: 'employee_ID'},
            {name: 'employeeName'},
            {name: 'mark'}
        ])
	});

    function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
    {
        if(<%=bMasterReadOnly ? "false" : "true"%>)
        {
           	return "<img  onclick=\"voidRequisition('"+record.data["refVerifier_ID"]+"','"+strGrid_ID+"','ECEVerifier');\""+
			    " src='./images/dcc/cross.gif' />";
        }else
            return ;
     }
 
 
    EngineeringVerfierGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: true,
		loadMask: true,
		viewConfig: {forceFit: true},
		width:831,
		autoHeight:true,
		ds: this.store,
		cm: this.cm,
		tbar:['<h1 class ="STYLE1">EC验证担当者</h1>','->',{
				text: '添加',
				id : 'add',
				iconCls:'add',
			    hidden :<%=bMasterReadOnly ? "true" : "false"%>,
			    handler:function()
			    { 
			    	winVerfier = new VerifierWindow( '<%=objOrder.getEngineeringChangeExamination_ID()%>' ,'<%=request.getContextPath()%>/org.do?department_ID=10000000' );
			    	winVerfier.show(this);
			    }
			 }]
	});
};
Ext.extend(EngineeringVerfierGrid, Ext.grid.GridPanel, {
	load: function() 
	{
	    this.condition.engineeringChangeExamination_ID ='<%=objOrder.getEngineeringChangeExamination_ID()%>' ;
	    this.condition.type ="ECE";  
		this.store.load();
	}
});
/************************************************************************/
/*************************NoticeCustomerGrid.js**************************/

//通知客户
var NoticeCustomerGrid=function(strGrid,strTitle)
{
      this.condition = {}; 
      this.store = new Ext.data.Store({
            baseParams: this.condition, 
            proxy: new Ext.data.HttpProxy({
	        method: 'POST',  
	        url:"customerSelected.do"}),
            reader: new Ext.data.JsonReader({
                totalProperty: 'totalProperty',
			    root: 'root'
			    },[
			    {name: 'relatedCustomer_ID'},
			    {name: 'customerName'},
			    
			    {name: 'position_FK'},
			    {name: 'positionName'},
			    
			    {name: 'followUp_FK'},
			    {name: 'followUpName'},
			     
			    {name: 'attachment_ID'},
			    {name: 'attachmentBase'},
                {name: 'fileName'},
			    
			    {name: 'dateOfResponse'},
			    {name: 'memo'},
			    {name: 'upload'},
			    {name: 'mark'}
            ]),
            remoteSort:true 
      });

      this.customerNameField=new Ext.form.TextField({
            id:'customerName',
            name:'customerName'
      });
      
      this.dateOfResponseDate=new Ext.form.DateField({
	        id:'dateOfResponse',
		    name:'dateOfResponse',
		    format:'Y-m-d'
	  });
     
      this.memoTextArea=new Ext.form.TextField({
	       //id:'memo',
		    name:'memo'
	  });
      
      this.positionCombo=new Ext.form.ComboBox({
	        id:'position_FK',
		    name:'position_FK',
		    valueField: 'key',
			displayField: 'value',
			editable: false, 
			mode: 'local',
			triggerAction:'all',
			store: new Ext.data.SimpleStore({
				fields: ['key', 'value'],
				data : FEEDBACKDEPT
			})
	  });
      
      this.followUpCombo=new Ext.form.ComboBox({
	        id:'followUp_FK',
		    name:'followUp_FK',
		    valueField: 'key',
			displayField: 'value',
			editable: false, 
			mode: 'local',
			triggerAction:'all',
			store: new Ext.data.SimpleStore({
				fields: ['key', 'value'],
				data : FOLLOWUP
			})
	  });
      
      this.cm = new Ext.grid.ColumnModel([
            {header:"客户名称",dataIndex:'customerName',<%=(objOrderMaster.getOrderTask_FK().equals("ECE150")) ? "editor:this.customerNameField," : ""%>renderer:qtips,width:140,sortable:true},
            {header:"反馈部门",dataIndex:'position_FK',<%=(objOrderMaster.getOrderTask_FK().equals("ECE150")) ? "editor:this.positionCombo," : ""%>width:290,sortable:true},
			{header:"处理方式",dataIndex:'followUp_FK',<%=(objAction.getBooleanFlag("feedBack")) ? "editor:this.followUpCombo," : ""%>width:200,sortable:true},
			{header:"记录",dataIndex:'fileName',renderer:renderUrl,width:190,sortable:true},
			{width: 30, dateIndex:'delete',renderer:deleteCusAttach,sortable:true},
			{width: 30, dateIndex:'upload',renderer:uploadCusAttach,sortable:true},
			{header:"日期",dataIndex:'dateOfResponse',<%=(objAction.getBooleanFlag("feedBack")) ? "editor:this.dateOfResponseDate," : ""%>width:120,sortable:true},
			{header:"备注",dataIndex:'memo',<%=(objAction.getBooleanFlag("feedBack")) ? "editor:this.memoTextArea," : ""%>renderer:qtips,width:180,sortable:true},
			{width: 65, dateIndex:'mark',renderer:renderDelete,sortable:true}
			
      ]);
      
      function renderUrl(value, cellmeta, record, rowIndex, columnIndex, store)
      {

            return "<a href=\"" +"<%=objAction.getFileUpLoadURL()%>" + "DccProcessFileDLDownloadServlet?accessCode=" + record.data["attachmentBase"]+"&orderTask="+'<%=nOrderTask%>'+"\" target='_blank'>"+value+"</a>";
      }
      
      function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
      {
       
         if(<%=(objOrderMaster.getOrderTask_FK().equals("ECE150"))&&bHasToken%>)
           {
           	  return "<img  onclick=\"voidRequisition('"+record.data["relatedCustomer_ID"]+"','"+strGrid+"','Customer');\""+
			    " src='./images/dcc/cross.gif' />";
           }else
              return ;
      }
      
       function deleteCusAttach(value, cellmeta, record, rowIndex, columnIndex, store)
      {
         if(<%=(objAction.getBooleanFlag("feedBack"))&&(objEngineeringChangeExaminationItemLast.getCusNotifiyFlag()==1)%>)
           {
           	  return "<img  onclick=\"deleteAttachment('"+record.data["attachment_ID"]+"','"+strGrid+"');\""+
			    " src='./images/dcc/cross.gif' />";
           }else
              return ;
      
      }
      
       function uploadCusAttach(value, cellmeta, record, rowIndex, columnIndex, store)
      {
      
        if(<%=(objAction.getBooleanFlag("feedBack"))&&(objEngineeringChangeExaminationItemLast.getCusNotifiyFlag()==1)%>)
           {
           	  return "<img  onclick=\"uploadCusAttachment('"+record.data["relatedCustomer_ID"]+"','"+strGrid+"');\""+
			    " src='./images/btn/btnUpload__c.gif'/>";
           }else
              return ;
      }
      
      NoticeCustomerGrid.superclass.constructor.call(this, {
            id:strGrid,
            viewConfig: {forceFit: true},
            ds:this.store,
            cm:this.cm,
            frame:false,
            loadMask: {msg:'正在加载数据，请稍侯……'}, 
            clicksToEdit:0,
            autoHeight:true,
            selModel: new Ext.grid.RowSelectionModel(),
            tbar:['<h1 class ="STYLE1">'+ strTitle + '</h1>','->',{
                text: '添加',
				id : 'bcustomer_add',
				hidden : true,
				tooltip:'添加一新客户',
				iconCls:'add',
				handler : function()
				{  
				       insertToDB("EC_D_RelatedCustomer",'<%=objEngineeringChangeExaminationItemLast.getDomain_ID()%>','1900-1-1 0:00:00',"customer"); 
				       var grid=Ext.getCmp(strGrid);
	                   grid.load();
				}		
			}]
	  });  
	  //通知客户  编辑  处理函数
	  this.on('afteredit',function(e){

		  var userPosition = getPositions('<%=objAction.getUser().getEmployee_FK()%>').split(",");
		  
		  var record = e.record;
		  //如果不是本单位、改变 客户名称、反馈部门栏位   return  
		  if(userPosition.indexOf(record.data.positionName) != -1 || record.modified.customerName != undefined || record.modified.position_FK != undefined ){
		  	if(e.field=="dateOfResponse")
		      {
		        updateToDB("EC_D_RelatedCustomer",e.field,record.get("relatedCustomer_ID"),Ext.util.Format.date(e.value,"Y-m-d"),"customer");
		      }else{
		        updateToDB("EC_D_RelatedCustomer",e.field,record.get("relatedCustomer_ID"),e.value,"customer");
		      }
		      
		  } else {
		  	console.log(record.get("followUpName"));
		  	Ext.Msg.alert('温馨提示：', '您没有权限修改其他部门的栏位');
		  	return
		  }
		  var grid=Ext.getCmp(strGrid);
	      grid.load();
	  });  
}
Ext.extend(NoticeCustomerGrid, Ext.grid.EditorGridPanel,{
    load:function()
    {
        this.condition.engineeringChangeExamination_ID ='<%=objOrder.getEngineeringChangeExamination_ID()%>';
	    this.condition.employee_FK = '<%=objAction.getUser().getEmployee_FK()%>';
	    this.condition.parent_FK = '<%=objAction.getBooleanSubmit(objAction.getUser().getEmployee_FK(),"ECE160") ? "1" : "0"%>';
	    this.store.load();
    }
});
/************************************************************************/
/**************************VerfyOrderGrid.js*****************************/
// 验证指令栏位
var VerfyOrderGrid=function(strGrid,strTitle)
{
      this.condition = {}; 
      this.store = new Ext.data.Store({ 
            baseParams: this.condition,  
            proxy: new Ext.data.HttpProxy({method: 'POST',url:"instructionSet.do"}),
            reader: new Ext.data.JsonReader({
                                              totalProperty: 'totalProperty',
			                                  root: 'root'
			                                },
                                            [ { name:'instructionSetExamination_ID' },
                                            { name: 'commander_FK' },
                                            { name: 'instructionType_FK' },{ name:'instructionTypeName' },
                                            { name:'commander_Name' },
                                            { name: 'instructionDesc' },
                                            { name: 'responsibleDept_FK' },{ name: 'responsibleDeptName'},
                                            { name: 'responsible_FK'},{ name: 'responsibleName' },
                                            { name: 'resultFlag' },
                                            { name: 'dateOfExpFinish' },
                                            { name: 'dateOfActFinish' },
                                            { name: 'responseDesc' },
                                            { name: 'confirmFlag' },
                                            {name: 'responsibleDeptHeader_FK'},{name: 'mark'},{name: 'sucessFlag'}
                                            ]),
            remoteSort:true 
      });
    
      var expander = new Ext.grid.RowExpander({
	           tpl: new Ext.XTemplate(
						'<div id ="subGrid" class="detailData">',
						'',
						'</div>'
			   )
      });
      
      expander.on("expand",function(expander,r,body,rowIndex){
               window.testEle=body;
               if(Ext.DomQuery.select("div.x-panel-bwrap",body).length==0)
               {
                    var grid=Ext.getCmp(strGrid);
		            var record=grid.getStore().getAt(rowIndex);
		            var str=record.get(("instructionTypeName"));
                    getSubOrder(str,body,record);
               }
      });
      
      function formatConfirm(value) 
      {
		return value==1 ? "是" : "否";
	  }
	  
	  function formatSucess(value) 
      {
		if(value==0) return "未定义";
		if(value==1) return "成功";
		if(value==2) return "失败";
	  }
	
	  this.instructionType_FKCombox=new Ext.form.ComboBox({
	        id:'instructionType_FK',
		    name:'instructionType_FK',
		    valueField: 'key',
			displayField: 'value',
			editable: false, 
			mode: 'local',
			triggerAction:'all',
			store: new Ext.data.SimpleStore({
				fields: ['key', 'value'],
				data : REQUESTSTRUCTION
			})
	  });

	  this.instructionDescTextArea=new Ext.form.TextField({
	        id:'instructionDesc',
	        grow:true,
		    name:'instructionDesc'
	  });
	  
	  this.responseDescTextArea=new Ext.form.TextField({
	        id:'responseDesc',
		    name:'responseDesc'
	  });
	  
	  this.dateOfExpFinishDate=new Ext.form.DateField({
	        id:'dateOfExpFinish',
		    name:'dateOfExpFinish',
		    readOnly:true,
		    format:'Y-m-d'
	  });
	  
	  this.dateOfActFinishDate=new Ext.form.DateField({
	        id:'dateOfActFinish',
		    name:'dateOfActFinish',
		    readOnly:true,
		    format:'Y-m-d'
	  });
	  
	  this.responsibleDept_FKTextField=new Ext.form.TextField({   
		     id:'responsibleDept_FK',
		     name:'responsibleDept_FK',
		     readOnly:true  
	  });
	  
	  this.responsible_FKTextField=new Ext.form.TextField({   
		     id:'responsible_FK',
		     name:'responsible_FK',  
		     readOnly:true   
	  });
	  
	  this.resultFlagCheckBox=new Ext.form.ComboBox({
	        id:'resultFlag',
		    name:'resultFlag',
		    valueField: 'key',
			displayField: 'value',
			editable: false, 
			mode: 'local',
			triggerAction:'all',
			store: new Ext.data.SimpleStore({
				fields: ['key', 'value'],
				data : [['0','否'],['1','是']]
			})
	  });
	  
	  this.confirmFlagCheckBox=new Ext.form.ComboBox({
	        id:'confirmFlag',
		    name:'confirmFlag',
		    valueField: 'key',
			displayField: 'value',
			editable: false, 
			mode: 'local',
			triggerAction:'all',
			store: new Ext.data.SimpleStore({
				fields: ['key', 'value'],
				data : [['0','否'],['1','是']]
			})
	  });
	  
	  this.sucessFlagCheckBox=new Ext.form.ComboBox({
	        id:'sucessFlag',
		    name:'sucessFlag',
		    valueField: 'key',
			displayField: 'value',
			editable: false, 
			mode: 'local',
			triggerAction:'all',
			store: new Ext.data.SimpleStore({
				fields: ['key', 'value'],
				data : [['0','未定义'],['1','成功'],['2','失败']]
			})
	  });
	  
	  //登陆的是管理员   可以进行 修改
      this.cm = new Ext.grid.ColumnModel([
             expander, 
      		{header:"指令人",dataIndex:"commander_Name",renderer:qtips,width:50,sortable:true},        
			{header:"指令类型",dataIndex:"instructionType_FK",<%=(objAction.getBooleanFlag("1")) ? "editor:this.instructionType_FKCombox," : "" %>renderer:qtips,width:165,sortable:true},
			{header:"任务描述",dataIndex:"instructionDesc",<%=(objAction.getBooleanFlag("1")) ? "editor:this.instructionDescTextArea," : "" %>renderer:qtips,width:127,sortable:true},
			{header:"负责单位",dataIndex:"responsibleDeptName",
			editor: <%=(objAction.getBooleanFlag("1") ||objOrderMaster.getOrderTask_FK().equals("ECE130"))%> || isManager('<%= objAction.getUser().getEmployee_FK()%>') ? this.responsibleDept_FKTextField : "",

			renderer:qtips,width:70,sortable:true},
			{header:"负责人",dataIndex:"responsibleName",
			editor: <%=(objAction.getBooleanFlag("2"))%> || isManager('<%= objAction.getUser().getEmployee_FK()%>') ? this.responsible_FKTextField : "",
			
			renderer:qtips,width:55,sortable:true},
			{header:"结果",dataIndex:"sucessFlag",<%=(objAction.getBooleanFlag("3")) ? "editor:this.sucessFlagCheckBox," : "" %>width:50,renderer:formatSucess,sortable:true},
			{header:"完成",dataIndex:"resultFlag",<%=(objAction.getBooleanFlag("3")) ? "editor:this.resultFlagCheckBox," : "" %>width:40,renderer:formatConfirm,sortable:true},
			{header:"计划完成日期",dataIndex:"dateOfExpFinish",<%=(objAction.getBooleanFlag("3")) ? "editor:this.dateOfExpFinishDate," : "" %>width:70,sortable:true},
			{header:"完成日期",dataIndex:"dateOfActFinish",<%=(objAction.getBooleanFlag("3")) ? "editor:this.dateOfActFinishDate," : "" %>width:65,sortable:true},
			{header:"完成状况",dataIndex:"responseDesc",<%=(objAction.getBooleanFlag("3")) ? "editor:this.responseDescTextArea," : "" %>renderer:qtips,width:127,sortable:true},
			{header:"确认",dataIndex:"confirmFlag",<%=(objAction.getBooleanFlag("2") || bConfirmMaster) ? "editor:this.confirmFlagCheckBox," : "" %>width:40,renderer:formatConfirm,sortable:true},
            {width: 40, dateIndex:'mark',renderer:renderDelete,sortable:true}
       ]);

       function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
       {  
         if(<%=objAction.getBooleanFlag("1")%>)
           {
           	  return "<img  onclick=\"voidECECommand('"+record.data["instructionSetExamination_ID"]+"','"+strGrid+"','ECECommand','" +record.data["commander_FK"]+ "');\""+
			    " src='./images/dcc/cross.gif' />";
           }else
              return ;
       }
             
       VerfyOrderGrid.superclass.constructor.call(this, {
            id:strGrid,
            //width:820,  
		    loadMask: {msg:'正在加载数据，请稍侯……'}, 
		    store:this.store, 
		    cm: this.cm, 
		    sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		    clicksToEdit:0,
            region: 'center',
            cls: 'x-rb',
            frame:false,
            plugins: [expander],
            viewConfig: {forceFit: true},
            autoHeight:true,
            tbar:[
            '<h1 class ="STYLE1">'+ strTitle +'<span style="color:red;">(提示：查看指令具体内容请点击指令前"+"号)</span>' + '</h1>','->',
            {
	            text: '添加主指令',
				id : 'bValidateEOM_add',
				tooltip:'添加一条验证指令',
				iconCls:'add',
			    hidden:<%=objAction.getBooleanFlag("1") ? false : true %>,
				handler : function()
				{  
				  insertToDB("EC_D_InstructionSetExamination",'<%=objEngineeringChangeExaminationItemLast.getDomain_ID()%>','<%=objAction.getUser().getEmployee_FK()%>',"ECEInstructionSet"); 
				  var grid = Ext.getCmp(strGrid);
				  grid.load();
				}
			},{
				text:'修改',
				id:'managerChange',
				tooltip:'管理员修改部门、责任人',
				iconCls:'change',
				hidden:true
			}
			],
			bbar: new Ext.PagingToolbar({
				pageSize: 50,
				store:this.store,
				displayInfo: true,
				displayMsg: '当前显示 {0} - {1}条记录 /共 {2}条记录',
				emptyMsg: "没有记录"
			})
	  });
	  //双击 指令触发事件
	  this.on('beforeedit',function(e){
	       var record = e.record;
	       var grid = Ext.getCmp(strGrid);
	       var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
	       var strCommander_FK = record.get("commander_FK");
	       var strDeptHeader_FK = record.get("responsibleDeptHeader_FK");
	       var strResponiser_FK = record.get("responsible_FK");
	       //管理员编辑则   越过判断直接  修改即可
	       if(jQuery('#managerChange')[0].dataset.flag === 'true'){
	       	  
	       	  console.log(e);
	       	  console.log(strGrid)
	          	if(e.field =="responsibleDeptName"){
					selectValue(strGrid,"responsibleDept_FK"); 
	          	}
	          	
	          	
	          	if(e.field == "responsibleName"){
	        		selectValue(strGrid,"responsible_FK"); 
	        	}
              
	       } else {
	       
		       	if(<%=objAction.getBooleanFlag("1")%>){
	              if(loginUser != strCommander_FK && !window.managerFlag){
	              	Ext.Msg.alert('温馨提示：', '您没有权限修改别人的指令');
		            return;
		          }else{
		          	if(e.field =="responsibleDeptName"){
						selectValue(strGrid,"responsibleDept_FK"); 
		          	}
	              }
		           
	           }else if(<%=objAction.getBooleanFlag("2")%>){
	           			console.log(2)
	            	     if(e.field == "responsibleName")
	            	     {
	            	        selectValue(strGrid,"responsible_FK"); 
	            	     }
	           }else if(<%=objAction.getBooleanFlag("3")%>){
	           		console.log(3)
	           }else{
					console.log('else')
		           if(loginUser == strCommander_FK)
		           {   
		           		if(<%=objOrderMaster.getOrderTask_FK().equals("ECE130")%>)
		           		{
		           			if(e.field =="responsibleDeptName")
	                      	{
							 	 updateValue(strGrid,"responsibleDept_FK");  
	                      	} 
		           		}
		           }
		       }
	       
	       }
	       
           
	  });
	  
	  this.on('afteredit', function (e) {
      var record = e.record;
      var grid = Ext.getCmp(strGrid);
      //判断 登陆的工号  如果不是对应行的 负责人 、 负责人主管   也不是 负责人、主管这段时间的的代理人   则不能修改 
      console.log('objAction.getUser().getEmployee_FK()');
	  var loginUser = "<%= objAction.getUser().getEmployee_FK() %>";
	  var empDeputy = getDeputy_FK(record.get("responsible_FK"));
	  var responsibleDeptHeader_FK = record.get("responsibleDeptHeader_FK");
	  var deptDeputy = getDeputy_FK(responsibleDeptHeader_FK);
	  var responsible_FK = record.get("responsible_FK");
	  //ECE130  登录的人  不是负责人、负责人主管、 负责人代理人、负责人主管代理人、则不能修改他人栏位。
	  if(loginUser != responsible_FK && responsibleDeptHeader_FK != loginUser && loginUser != empDeputy && loginUser != deptDeputy && <%=objOrderMaster.getOrderTask_FK().equals("ECE130")%>){
	  
		Ext.Msg.alert("温馨提示",'请不要修改其他人栏位');
		grid.load();
		return;
	  }
      if (e.field == "dateOfExpFinish" || e.field == "dateOfActFinish") {
				
        if (record.get("confirmFlag") == "1") {
          Ext.Msg.alert('温馨提示：', '该指令已经被主管确认，不能再更改，除非主管消除确认状态！');
          grid.load();
          return;
        }
        updateToDB("EC_D_InstructionSetExamination", e.field, record.get("instructionSetExamination_ID"), Ext.util.Format.date(e.value, "Y-m-d"), "ECECommand");
      } else if (e.field == "resultFlag") {
        if (record.get("confirmFlag") == "1") {
          Ext.Msg.alert('温馨提示：', '该指令已经被主管确认，不能再更改，除非主管消除确认状态！');
          grid.load();
          return;
        }
        if (e.value == "1") {
          if (record.get("dateOfActFinish") == "" || record.get("responseDesc") == "" || record.get("sucessFlag") == "0" || record.get("dateOfExpFinish") == "") {
            Ext.Msg.alert('温馨提示：', '该条指令您还没有填写完成日期、计划完成日期、完成状况或验证结果！');
            grid.load();
            return;
          }
          updateToDB("EC_D_InstructionSetExamination", "ResultFlag", record.get("instructionSetExamination_ID"), "1", "ECECommand");
        } else {
          updateToDB("EC_D_InstructionSetExamination", "ResultFlag", record.get("instructionSetExamination_ID"), "0", "ECECommand");
          if ( <%= objAction.getBooleanFlag("2") %> )
    {
      openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>", record.get("responsible_FK"), "open");
    }
	          }
	       }else if (e.field == "confirmFlag") {
      if (e.value == "1") {
        if (record.get("responsible_FK") == "") {
          Ext.Msg.alert('温馨提示：', '您没有选择负责人，暂时不能确认！');
          var grid = Ext.getCmp(strGrid);
          grid.load();
          return;
        } else {
          if (record.get("resultFlag") == "0") {
            Ext.Msg.alert('温馨提示：', '负责人处理完指令，暂时不能确认！');
            var grid = Ext.getCmp(strGrid);
            grid.load();
            return;
          }
        }

        if ( <%= bConfirmMaster %> )
        {
          if (loginUser == record.get("responsibleDeptHeader_FK")) {
            updateToDB("EC_D_InstructionSetExamination", "ConfirmFlag", record.get("instructionSetExamination_ID"), "1", "ECECommand");
          } else {
            Ext.Msg.alert('温馨提示：', '您没有权限来确认，但可以去除主管的确认，让他重新审核！');
            var grid = Ext.getCmp(strGrid);
            grid.load();
            return;
          }
        }else
        {
          updateToDB("EC_D_InstructionSetExamination", "ConfirmFlag", record.get("instructionSetExamination_ID"), "1", "ECECommand");
        }
      } else {
        updateToDB("EC_D_InstructionSetExamination", "ConfirmFlag", record.get("instructionSetExamination_ID"), "0", "ECECommand");
        updateToDB("EC_D_InstructionSetExamination", "ResultFlag", record.get("instructionSetExamination_ID"), "0", "ECECommand");
        if ( <%= bConfirmMaster %> )
        {
          openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>", record.get("responsibleDeptHeader_FK"), "open");
          openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>", record.get("responsible_FK"), "open");
        }else
        {
          openOrCloseApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>", record.get("responsible_FK"), "open");
        }
      }
    } else if (e.field == "instructionDesc") {
      var strCommander_FK = record.get("commander_FK");
      if (loginUser != strCommander_FK) {
        Ext.Msg.alert('温馨提示：', '您没有权限修改别人的指令');
        grid.load();
        return;
      } else {
        updateToDB("EC_D_InstructionSetExamination", e.field, record.get("instructionSetExamination_ID"), e.value, "ECECommand");
      }
    } else if (e.field == "responseDesc") {
      if (record.get("confirmFlag") == "1") {
        grid.load();
        return;
      } else {
        updateToDB("EC_D_InstructionSetExamination", e.field, record.get("instructionSetExamination_ID"), e.value, "ECECommand");
      }
    } else if (e.field == "instructionType_FK") {
      var instructionType = e.originalValue;
      var curInstruction = e.value;
      var a = (curInstruction == '710');
      if (a) {
        updateToDB("EC_D_InstructionSetExamination", 'responsibleDept_FK', record.get("instructionSetExamination_ID"), '10001012', "ECECommand");
        grid.load();
      }
      var instructionType_ID = instructionType.substring(1, 4);
      updateToDB("EC_D_InstructionSetExamination", e.field, record.get("instructionSetExamination_ID"), e.value, "ECECommand");
      if (instructionType_ID != "000")
        clearSubOrder(record.get("instructionSetExamination_ID"), instructionType_ID, '<%=objOrderMaster.getTrackingNumber()%>');
    } else if (e.field == "sucessFlag") {
      if (record.get("confirmFlag") == "1") {
        Ext.Msg.alert('温馨提示：', '该指令已经被主管确认，不能再更改，除非主管消除确认状态！');
        grid.load();
        return;
      }
      if (e.value == "1") {
        updateToDB("EC_D_InstructionSetExamination", "SucessFlag", record.get("instructionSetExamination_ID"), "1", "ECECommand");
      } else if (e.value == "2") {
        updateToDB("EC_D_InstructionSetExamination", "SucessFlag", record.get("instructionSetExamination_ID"), "2", "ECECommand");
      } else {
        updateToDB("EC_D_InstructionSetExamination", "SucessFlag", record.get("instructionSetExamination_ID"), "0", "ECECommand");
      }
    } else {
      updateToDB("EC_D_InstructionSetExamination", e.field, record.get("instructionSetExamination_ID"), e.value, "ECECommand");
    }
    grid.load();
	  });
}

Ext.extend(VerfyOrderGrid, Ext.grid.EditorGridPanel,{
    load:function()
    {
	    this.condition.type = "ECE";
	    this.condition.engineeringChangeExaminationItem_ID ='<%=objEngineeringChangeExaminationItemLast.getEngineeringChangeExaminationItem_ID()%>' ;
	    if(<%=objAction.getBooleanFlag("2")%>)
	    {
	    	this.condition.ECECondition = '<%=objAction.getUser().getEmployee().getDepartment().getDepartment_ID()%>';
	    }else if(<%=objAction.getBooleanFlag("3")%>)
	    {
	 	    this.condition.ECECondition = '<%=objAction.getUser().getEmployee_FK()%>';
	    }
	    this.condition.parent_FK = '<%=objAction.getBooleanSubmit(objAction.getUser().getEmployee_FK(),"ECE130") ? "1" : "0"%>';
	    this.condition.login_FK = '<%=objAction.getUser().getEmployee_FK()%>';
	    this.condition.orderTask = '<%=objOrderMaster.getOrderTask_FK()%>';
	    this.store.load({params:{start:0, limit:50}}); 
    }
});
/************************************************************************/
/**************************upLoadWindow.js*******************************/
function uploadWindow(strGrid_ID,fileKey) {
   var form = new Ext.form.FormPanel({ 
			labelAlign: 'right', 
			id:'fileForm',
			name:'fileForm',
			labelWidth: 70, 
			frame:true, 
			fileUpload: true, 
			items: [{ 
				xtype: 'textfield', 
				fieldLabel: '上传附件', 
				id:'fileName',
				name: 'fileName', 
				allowBlank:false,
				inputType: 'file',
				anchor:'90%'//文件类型 
			}],
			buttons: [{ 
						text: '上传', 
						iconCls:'upload',
						handler: function() 
						{ 
						      var fileForm = Ext.getCmp("fileForm");
						      var strAccessCode = "trackingNumber="+'<%=objOrderMaster.getTrackingNumber()%>'+"&ProcessInstance="+'<%=objOrderMaster.getProcessInstance()%>'+"&type=EC&fileKey="+fileKey;
						      if (fileForm.getForm().isValid()) 
						      {
						          fileForm.form.submit({
						                url : '<%=objAction.getFileUpLoadURL()%>' +'DccFileUploadServlet?'+strAccessCode,
				                        success : function()
				                        { 
				                           var objAttach = Ext.getCmp(strGrid_ID);
	                                       objAttach.load();
							               var objWin = Ext.getCmp("winAttachment");
	                                       objWin.close();
							            },
							            failure : function(form, action) 
					                    {
					                      Ext.Msg.alert('温馨提示：','附件上传失败!');
					                    },
					                    waitTitle:'请稍后',
					                    waitMsg : '正在上传，请稍后...'
					               });
						      
						      }else{
				                    Ext.Msg.alert('温馨提示:','请先选择附件!');
				              }
						}
			}]      
    });
    //if(!winAttachment){
       var winAttachment= new Ext.Window({
	            id:"winAttachment", 
	            title:"工程变更管理",
	            width:500,      
	            height:120,   
	            closeAction :'hide',   
	            plain:true,   
	            autoHeight:true,  
	            items:form
		});
   // }
		winAttachment.show();	
};
/************************************************************************/
/***************************selectValue**********************************/
function selectValue(strGrid,columnName)
{
       var strTreeURL = "";
       var grid=Ext.getCmp( strGrid);   
	   var record = grid.getSelectionModel().getSelected();
	   
       if(columnName == "responsibleDept_FK")
       {
       		strTreeURL = "./department.do?department_ID=10000000";
       }else if(columnName == "responsible_FK")
       {
            var dept_ID = record.get("responsibleDept_FK")
       		strTreeURL = "<%=request.getContextPath()%>/orgAll.do?department_ID="+dept_ID;
       }
       
       this.loader = new Ext.tree.TreeLoader({
         	 dataUrl:strTreeURL //异步读取的url       
       }); 
       
       var tree = new Ext.tree.TreePanel({
					useArrows:true,
					frame:true,  		
					autoScroll:true,
					width:350,
					height:450,
				    loader: this.loader
		});
		
		var root=new Ext.tree.AsyncTreeNode({
				text: 'IVO 龙腾光电',			
		        draggable:false,		
		        id:'10000000'
		});
		
        tree.setRootNode(root);
        root.expand(false,true);
        tree.on('dblclick', function(node){
               if(node.parentNode!=null)
               {
                   if(columnName == "responsibleDept_FK")
                   {
                   		if(node.id==10000000)
	                    {
	                        Ext.Msg.alert('温馨提示：', '请您选择负责部门！');
	                    }else
	                    {
		                    var strValue = node.id;
		                    
							
							console.log(jQuery('#managerChange')[0].dataset.flag)
							if(jQuery('#managerChange')[0].dataset.flag === 'true'){
							//是管理员操作修改   approvalrecode等
							
							//管理员操作     不能更换部门，只能重选原来的部门    
								if(record.data.responsibleDept_FK != strValue){
									Ext.Msg.alert('温馨提示：', '需修改负责单位请驳回至验证担当者,管理员仅允许重选原负责单位,更新主管。');
									win.hide();
									return;
								} else {
								
									updateToDB("EC_D_InstructionSetExamination",columnName,record.get("instructionSetExamination_ID"),strValue,"ECECommand");
									
									//原update approvalRecode 通过 部门编号找到主管工号从而进行  更换 
									// updateResponsibleDept_FK('<%=objOrderMaster.getTrackingNumber()%>',record.get("responsibleDept_FK"),strValue);
									
									//修改approvalrecode 此单号、此部门部门主管的工号                   在主管给自己下指令时无效。
									updateResponsibleDept_Head('<%=objOrderMaster.getTrackingNumber()%>',strValue);
								
									
									clearResponsibleTask('<%=objOrderMaster.getTrackingNumber()%>',record.get("responsible_FK") );
									updateToDB("EC_D_InstructionSetExamination","Responsible_FK",record.get("instructionSetExamination_ID"),"","ECECommand");
									updateToDB("EC_D_InstructionSetExamination","ConfirmFlag",record.get("instructionSetExamination_ID"),"0","ECECommand");
								}
								
							
							} else {
								//不是管理员操作不修改   approvalrecode 只更新  instruction
			                    updateToDB("EC_D_InstructionSetExamination",columnName,record.get("instructionSetExamination_ID"),strValue,"ECECommand");
							}			            
				            
				            win.hide();
				            grid.load();
			            }
                   }else if(columnName == "responsible_FK")
                   {
                  
                       if(node.leaf==true)
                       {
                            var strValue = node.id;
                            var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
                            
                            var responsibleDeptHeader_FK = record.get("responsibleDeptHeader_FK");
	  						var deptDeputy = getDeputy_FK(responsibleDeptHeader_FK);
	  						
	  						//修改负责人  拦截 仅允许 修改本部门的负责人。
	  						
                            if(loginUser != responsibleDeptHeader_FK && loginUser != deptDeputy && <%=objOrderMaster.getOrderTask_FK().equals("ECE130")%> && !window.managerFlag){
                            	Ext.Msg.alert('温馨提示：', '请不要修改其他人栏位！');
                            	return
                            }else{
                            	//管理员修改时
                            	if(jQuery('#managerChange')[0].dataset.flag === 'true'){
                            		//主管未选择负责人，管理员不能修改
                            		if(record.get("responsible_FK") ==""){
                            			Ext.Msg.alert('温馨提示：', '负责人请由对应主管进行选择,如果主管更换请重选对应负责单位,此修改仅适用于负责人离职且指令未执行完毕。');
                            			win.hide();
                            			return; 
                            		} else {
                          			    updateResponsible('<%=objOrderMaster.getOrderMaster_ID()%>',record.get("responsible_FK"),strValue,record.get("responsibleDept_FK"));
					                    updateToDB("EC_D_InstructionSetExamination",columnName,record.get("instructionSetExamination_ID"),strValue,"ECECommand");
							            win.hide(); 
							            grid.load();
							            openOrCloseManagerApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","ECE130","<%=objAction.getUser().getEmployee_FK()%>","close");
                            		}
                            	} else {
                            		//不是管理员 修改
	                            	if(record.get("responsible_FK") =="")
			                        {
										insertApprovalRecord('<%=objOrderMaster.getOrderMaster_ID()%>', strValue);
			                        }else{
			                            updateResponsible('<%=objOrderMaster.getOrderMaster_ID()%>',record.get("responsible_FK"),strValue,record.get("responsibleDept_FK"));
			                        }
				                    updateToDB("EC_D_InstructionSetExamination",columnName,record.get("instructionSetExamination_ID"),strValue,"ECECommand");
						            win.hide(); 
						            grid.load();
						            openOrCloseManagerApprovalRecord("<%=objOrderMaster.getOrderMaster_ID()%>","ECE130","<%=objAction.getUser().getEmployee_FK()%>","close");
                            	}
                           	}
                            
                       }else{
                       		Ext.Msg.alert('温馨提示：', '请您选择负责人员！');
                       }
                   }
			   }
	            
        });
        var  win= new Ext.Window({
	            modal:true,  
	            title:"工程变更管理",
	            closable:true,   
	            width:350,      
	            height:450,   
	            resizable:true,   
	            closeAction :'hide',   
	            plain:true,   
	            autoScroll: false, 
	            autoHeight:true,  
	            items:[tree]
		});
		win.show();	
}
/*************************updateValue.js*********************************/
/************************************************************************/
function updateValue(strGrid,columnName) {
	var strTreeURL = "";
	var grid=Ext.getCmp( strGrid);
	var record = grid.getSelectionModel().getSelected();
	strTreeURL = "./department.do?department_ID=10000000";

	this.loader = new Ext.tree.TreeLoader({dataUrl:strTreeURL}); 

	var tree = new Ext.tree.TreePanel({useArrows:true,frame:true,autoScroll:true,width:350,height:450,loader: this.loader});

	var root=new Ext.tree.AsyncTreeNode({
		text: 'IVO 龙腾光电',
		draggable:false,
		id:'10000000'
	});

	tree.setRootNode(root);
	root.expand(false,true);
	tree.on('dblclick', function(node) {
		console.log(node);
		if(node.parentNode!=null) {
			if(node.id==10000000) {
				Ext.Msg.alert('温馨提示：', '请您选择负责部门！');
			} else {   
				var strValue = node.id;
				var b = record.get("responsibleDept_FK")
				if( strValue != record.get("responsibleDept_FK") ) {
					updateResponsibleDept_FK('<%=objOrderMaster.getTrackingNumber()%>',record.get("responsibleDept_FK"),strValue);
					updateToDB("EC_D_InstructionSetExamination",columnName,record.get("instructionSetExamination_ID"),strValue,"ECECommand");
					clearResponsibleTask('<%=objOrderMaster.getTrackingNumber()%>',record.get("responsible_FK") );
					updateToDB("EC_D_InstructionSetExamination","Responsible_FK",record.get("instructionSetExamination_ID"),"","ECECommand");
					updateToDB("EC_D_InstructionSetExamination","ConfirmFlag",record.get("instructionSetExamination_ID"),"0","ECECommand");
				}
				win.hide();
				grid.load();
			}
		}
	});
	var  win= new Ext.Window({
	            modal:true, 
	            title:"工程变更管理",
	            closable:true, 
	            width:350, 
	            height:450, 
	            resizable:true, 
	            closeAction :'hide', 
	            plain:true, 
	            autoScroll: false, 
	            autoHeight:true, 
	            items:[tree]
		});
		win.show();	
}
/************************************************************************/
/*************************voidRequisition.js*****************************/
function voidECECommand(strRequisition_ID,strGrid_ID,strType,commander_FK) {
	if(commander_FK != '<%=objAction.getUser().getEmployee_FK()%>') {
		Ext.Msg.alert('温馨提示：', '您没有权限删除别人的指令!');
		return;
	} else {
		jQuery.ajaxSetup({async:false});
		jQuery.post("eceService.do?m=deleteRequisition",{"id":strRequisition_ID,"action":strType},function(data){
			if(data=="ok") {
			var grid=Ext.getCmp(strGrid_ID);
				grid.load();
			} else {
				Ext.Msg.alert('信息', '删除出错，请联系系统管理员!');
			}
		});
	}
}
/************************************************************************/
/************************deleteRequisition.js****************************/
function deleteRequisition() {
	jQuery.ajaxSetup({async:false});
	jQuery.post("eceService.do?m=deleteRequisition",{"id":"<%=objOrderMaster.getOrderMaster_ID()%>","action":"ECE"},function(data){
		if(data=="ok") {
			Ext.MessageBox.show({title:'温馨提示：',msg: '该工程变更申请已经删除！',buttons: Ext.MessageBox.OK,fn: function(){window.close();}});
		} else {
			Ext.Msg.alert('信息', '删除出错，请联系系统管理员!');
		}
	});
}
/************************************************************************/
function getNextHander() {
	var result = "";
	jQuery.ajaxSetup({async:false});
	jQuery.post("eceService.do?m=getNextHander",{"trackingNumber":"<%=objOrderMaster.getOrderMaster_ID()%>","sender":"<%=objAction.getUser().getEmployee_FK()%>"},function(data){
		if(data=="ok") {
			result = data;
		} else {
			Ext.Msg.alert('信息', '删除出错，请联系系统管理员!');
		}
	});
	return result;
}
/************************************************************************/
function submitMemo(btn,text) {
	if(btn == 'ok') {
		document.getElementById("actionComment").value =text;
		if(<%=(nOrderTask == objAction.TASK_Abolishing)%>) {
			submitInformation("abolish");
		} else {
			submitInformation("submit");
		}
	} else if(btn == 'cancel') {return};
}
/************************************************************************/
function sendToExcute(btn,text) {
	if(btn == 'ok') {
		document.getElementById("actionComment").value =text;
		submitInformation("excute");  
	} else if(btn == 'cancel') {return};
}
/************************************************************************/

var MaterialRequestGrid=function(strInstructionSetExamination_ID,body,record) {
	//collectECEMaterialList = getDetailList(strInstructionSetExamination_ID,"materialRequisition");
	this.selectECEMaterialGrid=new SelectMaterialGrid("selectECEMaterialGrid"+strInstructionSetExamination_ID);
	this.ECESelectedMaterialGrid=new ECEMaterialSelectedGrid("ECESelectedMaterialGrid"+strInstructionSetExamination_ID);
	var save = function() {
		if(collectECEMaterialList=="") {
			Ext.Msg.alert('温馨提示：', '请选择料号申请单号');
			return;
		} else {
			insertToDB("EC_D_InstructionBodyMatReqExamination",strInstructionSetExamination_ID ,collectECEMaterialList,"MaterialRequisition");
			var grid=Ext.getCmp(strInstructionSetExamination_ID);
			grid.load();
			var window = Ext.getCmp("winECEMaterialList"+strInstructionSetExamination_ID);
			window.hide();
		}
	};
	var removeAll = function(){
		collectECEMaterialList = "";
		this.ECESelectedMaterialGrid.condition.type=collectECEMaterialList;
		this.ECESelectedMaterialGrid.load();
	}; 
	this.selectECEMaterialGrid.on({'rowdblclick':rowClickSelectECR});
	function rowClickSelectECR(grid,rowIndex, e) {
		var row = grid.getSelectionModel().getSelected();  
		if(collectECEMaterialList=="") {
			collectECEMaterialList = row.get("trackingNumber");
		} else {
			var collectECEMaterialLists=collectECEMaterialList.split(",");
			var j=collectECEMaterialLists.length;
			for(var i=0;i < j;i++) {
				if(collectECEMaterialLists[i]==row.get("trackingNumber")) {
					for(var t=i;t<j;t++) {
						collectECEMaterialLists[t]=collectECEMaterialLists[t+1];
					}
					j=j-1;
				}
			}
			if(j==0) {
				collectECEMaterialList = row.get("trackingNumber");
			} else {
				for(var m=0;m<j;m++) {
					if(m==0) {
						collectECEMaterialList=collectECEMaterialLists[m];
					} else {
						collectECEMaterialList=collectECEMaterialList+","+collectECEMaterialLists[m];
					}
				}
				collectECEMaterialList = collectECEMaterialList+","+row.get("trackingNumber");
			}
		}
		var selectGrid = Ext.getCmp("ECESelectedMaterialGrid"+strInstructionSetExamination_ID);
		selectGrid.condition.type = collectECEMaterialList;
		selectGrid.load();
	}
        
        this.ECESelectedMaterialGrid.on({'rowdblclick':rowClickRemoveSelect});
        function rowClickRemoveSelect(grid,rowIndex, e)
        {
	        var row = grid.getSelectionModel().getSelected(); 
	        var collectECEMaterialLists = collectECEMaterialList.split(",");
	        var j = collectECEMaterialLists.length;
	        for(var i=0;i < j;i++)
	        {
		        if(collectECEMaterialLists[i]==row.get("trackingNumber"))
		        {
			          for(var t=i;t<j;t++)
			          {
			          collectECEMaterialLists[t]=collectECEMaterialLists[t+1];
			          }
			          j=j-1;
		        }
	        }
	        if(j==0)collectECEMaterialList = "";
	        else
		    {
			    for(var m=0;m<j;m++)
			    {
			       if(m==0)collectECEMaterialList=collectECEMaterialLists[m];
			       else
			       collectECEMaterialList=collectECEMaterialList+","+collectECEMaterialLists[m];
			    }
		    } 
	        grid.condition.type = collectECEMaterialList;
	        grid.load();
	    }
        
         this.ECEMaterialListPanel = new Ext.FormPanel({
		        id: 'ECEMaterialListPanel'+strInstructionSetExamination_ID,
				region : 'center',
				width:500,
				height:550,
				layout: 'column',
				buttonAlign:'center',
				items: [{
		            columnWidth: 0.49,
		            layout: 'fit',
		            width:300,
				    height:505,
		            items:[this.selectECEMaterialGrid]
	               },
		            {
		            columnWidth: 0.02,
		            width:300,
				    height:505,
		            layout: 'fit'
		           },
		            {
		        	columnWidth: 0.49,
		            width:300,
				    height:505,
		            title:'已选取的料号申请单',
		            items:[this.ECESelectedMaterialGrid]
		            }]  
		 });
        
         this.showECEMaterialWindow = function(){
	         var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
	         var strCommander_FK = record.get("responsible_FK");
	         var delegater = '<%=strDelegater%>';
             if( strCommander_FK == loginUser || strCommander_FK == delegater )
             {
			      if (!this.ECEMaterialListWindow) {
                      this.ECEMaterialListWindow = new Ext.Window({
							id:'winECEMaterialList'+strInstructionSetExamination_ID,
			                layout:'fit',
			                title:'料号申请单选择',
			                width: 600,
			                height:580,
			                closeAction:'hide',
			                plain: true,
			                closable:false,
			                buttonAlign:'center',
							items: this.ECEMaterialListPanel,
						    buttons: [{
			                    text:'确定',
			                    disabled:false,
			                    handler: save.createDelegate(this)
			                },{
			                    text:'删除所有',
			                    disabled:false,
			                    handler: removeAll.createDelegate(this)
			                },{
			                    text: '关闭',
			                    handler: function(){
			                    var window = Ext.getCmp("winECEMaterialList"+strInstructionSetExamination_ID);
			                    window.hide();
			                    }
			                }]
			            });
			       }
			       this.selectECEMaterialGrid.condition.type="material";
			       collectECEMaterialList = getDetailList(strInstructionSetExamination_ID,"materialRequisition");
	               this.selectECEMaterialGrid.load({params:{start:0, limit:20}});
	               this.ECESelectedMaterialGrid.condition.type = collectECEMaterialList;
	               this.ECESelectedMaterialGrid.load();
	               this.ECEMaterialListWindow.show();
	          }
		 };	
      
      this.instructionSetExamination_FK = strInstructionSetExamination_ID;
      this.condition = {}; 
      this.cm = new Ext.grid.ColumnModel([
           new Ext.grid.RowNumberer(),
           {header:"料号申请单",dataIndex:"matReqNumber",sortable:true,width:window.document.body.clientWidth/1.7},
           {dataIndex:"mark",sortable:true,renderer:renderDelete,width:window.document.body.clientWidth/25}					
	  ]);
	  Ext.DomQuery.select("div.detailData")[0];  
	  
	  var strCommander_FK = record.get("responsible_FK");
      function renderDelete (value, cellmeta, record, rowIndex, columnIndex, store) 
      {
        if( <%= objAction.getBooleanFlag("3") ? "true" : "false"%>)
        {
            var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
            var delegater = '<%=strDelegater%>';
	        if(loginUser == strCommander_FK || strCommander_FK == delegater)
	        {
            	return "<img  onclick=\"voidRequisition('"+record.data["instructionBodyMatReqExamination_ID"]+"','" + strInstructionSetExamination_ID + "','MaterialRequest');\""+
			             " src='./images/dcc/cross.gif' />";
			}else{
			    return;
			}
	    }else{
	        return;
	    }
      }
      
	  this.store = new Ext.data.Store({
		    baseParams: this.condition, 
	        proxy: new Ext.data.HttpProxy(
			{method: 'POST',  
			url:'ECEsubOrderSet.do'}),
	        reader: new Ext.data.JsonReader({
				 totalProperty: 'totalProperty',
				 root: 'root'
				}, [
				{name: 'instructionBodyMatReqExamination_ID'},
				{name: 'matReqNumber'},
				{name: 'mark'}
	        ]),
	        remoteSort:true 
      });    

	  MaterialRequestGrid.superclass.constructor.call(this, {
	        id:strInstructionSetExamination_ID,
	        ds: this.store,
	        cm: this.cm,
	        // loadMask:true,
	        renderTo:Ext.DomQuery.select("div.detailData",body)[0],
	        //autoWidth:true,
	        //autoHeight:true,
	        /*********自己定义格式1**********/
	        autoHeight:true,
	        width:window.document.body.clientWidth/1.55,
	        trackMouseOver:false, 
	        loadMask: {msg:'正在加载数据，请稍侯……'},
	        height:150,
	        viewConfig: {forceFit: false},
	        /****************************/
	        tbar:[{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '添加',
	            iconCls:'add',
	            tooltip:'添加物料申请单',
	            hidden:<%=objAction.getBooleanFlag("3") ? "false" : "true"%>,
	            anchor:'20%',
	            handler:this.showECEMaterialWindow.createDelegate(this, [true])
	        },{
	            text:'查看',
	            iconCls:'agree',
	            tooltip:'选中一行查看',
	            handler:function()
	            {
	                var grid = Ext.getCmp(strInstructionSetExamination_ID);
	            	var row = grid.getSelectionModel().getSelected(); 
	            	var strTrackingNumber = row.get("matReqNumber");
	            	var strUrl = window.base+"/pages/mm/MaterialRequisition.jsp?trackingNumber="+strTrackingNumber;
	            	if(row)
	            	{
	            	   window.open( strUrl, "", "left=0, top=0, width=1012px, height=635px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0 " ); 
	            	}else{
	            	   Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
	            	   return;
	            	}
	            }
	        }]  
	  });
}
Ext.extend(MaterialRequestGrid, Ext.grid.GridPanel,{
    load:function(){
    this.condition.type = "materialRequisition";
    this.condition.instructionSetExamination_ID = this.instructionSetExamination_FK;
    this.store.load();
    }
});
/************************************************************************/
/************************************************************************/
var InstructionSetBodyBomRequestGrid=function(strInstructionSetExamination_ID,strInstructionSet_FK,body,record) {
	var bomFlag = (record.get("resultFlag") != "1");
	this.instructionSetExamination_FK = strInstructionSetExamination_ID;
	this.condition = {};
	this.cm = null;
	var strInstructionType_FK = record.get("instructionTypeName");
	var bomFlag2 = <%=(objOrder.getBomFlag()==0) ? "true" : "false"%>;
	if(bomFlag2) {
		this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(), {
				dataIndex:"mark",
				sortable:true,
				renderer:renderDelete,
				width:50
			},{dataIndex:"update",
				sortable:true,
				renderer:renderUpdate,
				width:25
			},{header:"变更操作",
				dataIndex:"instructionActionName",
				sortable:true,
				//width:60
				width:95
			},{header:"旧零件料号",
				dataIndex:"oldComponent_FK",
				sortable:true,
				//width:60
				width:80
			},{header:"新零件料号",
				dataIndex:"newComponent_FK",
				sortable:true,
				//width:60
				width:80
			},{header:"旧品名",
				dataIndex:"oldSpecification",
				sortable:true,
				renderer:qtips,
				//width:60
				width:130
			},{header:"新品名",
				dataIndex:"newSpecification",
				sortable:true,
				renderer:qtips,
				//width:60
				width:130
			},{header:"旧用量",
				dataIndex:"oldQuantity",
				sortable:true,
				width:60
			},{header:"新用量",
				dataIndex:"newQuantity",
				sortable:true,
				width:60
			},{header:"工厂范围",
				dataIndex:"businessUnitName",
				sortable:true,
				width:150
			},{header:"旧成品料号",
				dataIndex:"oldProductType_FK",
				sortable:true,
				width:90
			},{header:"新成品料号",
				dataIndex:"newProductType_FK",
				sortable:true,
				width:90
			},{header:"旧生产版本",
				dataIndex:"oldProdVersion",
				sortable:true,
				width:80
			},{header:"新生产版本",
				dataIndex:"newProdVersion",
				sortable:true,
				width:80
			},{header:"可选BOM",
				dataIndex:"altBom",
				hidden:true,
				sortable:true,
				width:60
			},{header:"生效日期类型",
				dataIndex:"effectMethodName",
				sortable:true,
				width:110
			},{header:"生效日期",
				dataIndex:"dateOfEffect",
				sortable:true,
				width:70
			},{header:"附注",
				dataIndex:"memo",
				sortable:true,
				renderer:qtips,
				width:130
			}
		]);
	} else {
		if(strInstructionType_FK == "130"){
			this.cm = new Ext.grid.ColumnModel([
				new Ext.grid.RowNumberer(), {
					dataIndex:"mark",
					sortable:true,
					renderer:renderDelete,
					width:35
				},{
					dataIndex:"update",
					sortable:true,
					renderer:renderUpdate,
					width:35
				},{
					header:"BOM申请单号",
					dataIndex:"bomReqNumber",
					sortable:true,
					width:235
				},{
					header:"成品料号",
					dataIndex:"bomReqProduct",
					sortable:true,
					width:235
				},{
					header:"成产版本",
					dataIndex:"bomReqVersion",
					sortable:true,
					width:235
				}
			]);
		} else {
			this.cm = new Ext.grid.ColumnModel([
				new Ext.grid.RowNumberer(),{
					dataIndex:"mark",
					sortable:true,
					renderer:renderDelete,
					width:35
				},{
					dataIndex:"update",
					sortable:true,
					renderer:renderUpdate,
					width:25
				},{
					header:"变更操作",
					dataIndex:"instructionActionName",
					sortable:true,
					width:100
				},{header:"旧零件料号",
					dataIndex:"oldComponent_FK",
					sortable:true,
					width:80
				},{header:"新零件料号",
					dataIndex:"newComponent_FK",
					sortable:true,
					width:80
				},{header:"旧品名",
					dataIndex:"oldSpecification",
					sortable:true,
					renderer:qtips,
					width:130
				},{header:"新品名",
					dataIndex:"newSpecification",
					sortable:true,
					renderer:qtips,
					width:130
				},{header:"旧用量",
					dataIndex:"oldQuantity",
					sortable:true,
					width:60
				},{header:"新用量",
					dataIndex:"newQuantity",
					sortable:true,
					width:60
				},{header:"工厂范围",
					dataIndex:"businessUnitName",
					sortable:true,
					width:150
				},{header:"可选BOM",
					dataIndex:"altBom",
					sortable:true,
					hidden:true,
					width:60
				},{header:"生效日期类型",
					dataIndex:"effectMethodName",
					sortable:true,
					width:110
				},{
					header:"生效日期",
					dataIndex:"dateOfEffect",
					sortable:true,
					width:70
				},{header:"附注",
					dataIndex:"memo",
					sortable:true,
					renderer:qtips,
					width:130
				}
			]);
		}
	}

	var strCommander_FK = record.get("commander_FK");
	function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) {
		if(<%=objAction.getBooleanFlag("1")%>) {
			var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
			var delegater = '<%=strDelegater%>';
			if(loginUser == strCommander_FK || strCommander_FK == delegater) {
				return "<img  onclick=\"voidRequisition('"+record.data["instructionBodyBomExamination_ID"]+"','" + strInstructionSetExamination_ID + "','bomExamination');\""+
						" src='./images/dcc/cross.gif' />";
			} else {
				return ;
			}
		} else {
			return ;
		}
	}

	function renderUpdate(value, cellmeta, record, rowIndex, columnIndex, store) {
		if(<%=objAction.getBooleanFlag("1")%>) {
			var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
			var delegater = '<%=strDelegater%>';
			if(loginUser == strCommander_FK || strCommander_FK == delegater) {
				if(strInstructionSet_FK == "130") {
					return "<img  onclick=\"updateCreateBomExamination('"+ strInstructionSetExamination_ID + "','"+strInstructionSet_FK+"');\"" +
							" src='./images/test6.png' />";
				} else if(strInstructionSet_FK == "131") {
					return "<img  onclick=\"UpdateEditorBomExamination('"+strInstructionSetExamination_ID+"','" + strInstructionSet_FK + "');\""+
						" src='./images/test6.png' />";
				}
			} else {
				return ;
			}
		} else {
			return ;
		}
	}

	Ext.DomQuery.select("div.detailData")[0];
	this.store = new Ext.data.Store({
		baseParams: this.condition,
		proxy: new Ext.data.HttpProxy({method: 'POST', url:'ECEsubOrderSet.do'}),
		reader: new Ext.data.JsonReader({totalProperty: 'totalProperty',root: 'root'},
		[
			{name: 'instructionBodyBomExamination_ID' },{name: 'instructionAction_FK' },{name: 'instructionActionName' },
			{name:'oldComponent_FK'},{name:'newComponent_FK'},{name:'oldSpecification'},
			{name:'newSpecification'},{name:'oldQuantity'},{name:'newQuantity'},{name:'altBom'},
			{name:'businessUnit_FK'},{name:'businessUnitName'},{name:'oldProductType_FK'},{name:'newProductType_FK'},
			{name: 'oldProdVersion'},{name: 'newProdVersion'},{name:'effectMethod_FK'},{name:'dateOfEffect'},
			{name:'effectMethodName'},{name:'bomReqNumber'},{name:'bomReqProduct'},{name:'bomReqVersion'},{name:'memo'},{name:'update'},{name:'mark'}
		]),
		remoteSort:true
	});

	InstructionSetBodyBomRequestGrid.superclass.constructor.call(this, {
	        id:strInstructionSetExamination_ID,
	        ds: this.store,
	        cm: this.cm,
	        renderTo:Ext.DomQuery.select("div.detailData",body)[0],
	        //autoWidth:true,
	        //autoHeight:true,
	         /*********自己定义格式1**********/
	        autoHeight:false,
	        width:window.document.body.clientWidth/1.55,
	        trackMouseOver:false, 
	        loadMask: {msg:'正在加载数据，请稍侯……'},
	        height:150,
	        viewConfig: {forceFit: false},
	        /****************************/
	        /*********自己定义格式2**********/
	        /***
            autoScroll:true,  
            width:Ext.get("subGrid").getWidth(), 
            height:Ext.get("subGrid").getWidth()/2,  
	        loadMask: {msg:'正在加载数据，请稍侯……'}, 
	        trackMouseOver:false, 
	        //viewConfig: {forceFit: false},
	          **/
	        /****************************/
			tbar:[{
				text: '',anchor:'20%'
			},{
				text: '',anchor:'20%'
			},{
				text: '',anchor:'20%'
			},{
				text: '',anchor:'20%'
			},{
				text: '',anchor:'20%'
			},{
				text: '物料反查清单',
				anchor:'20%',
				iconCls:'agree',
				tooltip:'选中一行查看当前料号在BOM使用情况',
				hidden:!( (bomFlag2&&(strInstructionType_FK == "130")) || strInstructionType_FK == "131"),
				handler:function() {
					var grid = Ext.getCmp(strInstructionSetExamination_ID);
					var row = grid.getSelectionModel().getSelected();
					if(row) {
						if( row.get("oldComponent_FK")=="") {
							Ext.Msg.alert('温馨提示：', '旧零件料号为空，无法提供报表');
							return;
						} else {
							materialUsedInBomDetail(row.get("oldComponent_FK"));
						}
					} else {
						Ext.Msg.alert('温馨提示：', '请选中你要查看BOM的旧零件料号');
						return;
					}
				}
			},{
				text: '查看BOM创建',
				iconCls:'agree',
				tooltip:'选中一行查看BOM创建',
				anchor:'20%',
				hidden:!(!bomFlag2&&(strInstructionType_FK == "130")),
				handler:function() {
					var grid = Ext.getCmp(strInstructionSetExamination_ID);
					var row = grid.getSelectionModel().getSelected(); 
					if(row) {
						var strBomReqNumber = row.get("bomReqNumber");
						window.open(window.base+"/pages/pp/BOMRequisition.jsp?trackingNumber="+strBomReqNumber , "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, " );
					} else {
						Ext.Msg.alert('温馨提示：', '请选种你要查看的BOM');
						return;
					}
				}
			},{
				text: '增加',
				iconCls:'add',
				tooltip:'添加一条BOM指令',
				hidden:<%=objAction.getBooleanFlag("1") ? "false" : "true"%>,
				anchor:'20%',
				handler:function() {
					var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
					var strCommander_FK = record.get("commander_FK");
					var delegater = '<%=strDelegater%>';
					if( strCommander_FK == loginUser || strCommander_FK == delegater ) {
						if(strInstructionSet_FK == "130") {
						addCreateBomExamination(strInstructionSetExamination_ID,strInstructionSet_FK);
					} else if(strInstructionSet_FK == "131") {
						addEditorBomExamination(strInstructionSetExamination_ID,strInstructionSet_FK);
					}
				}
			}
		}]
	});
}
Ext.extend(InstructionSetBodyBomRequestGrid, Ext.grid.GridPanel,{
	load:function(){
		this.condition.type = "bomExamination";
		this.condition.instructionSetExamination_ID = this.instructionSetExamination_FK;
		this.store.load(); 
	}
});
/************************************************************************/
/************************************************************************/
var InstructionSetBodyOnlineGrid=function(strInstructionSetExamination_ID,body,record)
{
        //collectECEOnLinelList = getDetailList(strInstructionSetExamination_ID,"onLine");
        this.selectECEOnLineGrid=new SelectOnLineGrid("selectECEOnLineGrid"+strInstructionSetExamination_ID);
        this.ECESelectedOnLineGrid=new ECEOnLineSelectedGrid("ECEOnLineSelectedGrid"+strInstructionSetExamination_ID);

        var save = function()
        {
           if(collectECEOnLinelList=="")
           {
               Ext.Msg.alert('温馨提示：', '请选择实验申请单号');
               return;
           }else{
               insertToDB("EC_D_InstructionBodyOnlineExamination",strInstructionSetExamination_ID ,collectECEOnLinelList,"onLine");
               var grid=Ext.getCmp(strInstructionSetExamination_ID);
               grid.load();
               var window = Ext.getCmp("winECEOnLineList"+strInstructionSetExamination_ID);
			   window.hide();   
			   Ext.Msg.alert('温馨提示：', '是否有中量或大量验证,如有,请选择中、大量SWR！');           
           }          
	    };
      
        var removeAll = function(){
			    collectECEOnLinelList = "";
				this.ECESelectedOnLineGrid.condition.type=collectECEOnLinelList;
				this.ECESelectedOnLineGrid.load();
		}; 
        
        this.selectECEOnLineGrid.on({'rowdblclick':rowClickSelectECR});
		function rowClickSelectECR(grid,rowIndex, e) 
		{
	        var row = grid.getSelectionModel().getSelected();  
	        if(collectECEOnLinelList=="")collectECEOnLinelList = row.get("trackingNumber");
	        else
	        {
	           var collectECEOnLinelLists=collectECEOnLinelList.split(",");
	           var j=collectECEOnLinelLists.length;
	           for(var i=0;i < j;i++)
			   {
			        if(collectECEOnLinelLists[i]==row.get("trackingNumber"))
			        {
				          for(var t=i;t<j;t++)
				          {
				             collectECEOnLinelLists[t]=collectECEOnLinelLists[t+1];
				          }
				          j=j-1;
			        }
			   }
			   if(j==0)collectECEOnLinelList = row.get("trackingNumber");
			   else
               {
                   for(var m=0;m<j;m++)
                   {
                      if(m==0)collectECEOnLinelList=collectECEOnLinelLists[m];
                      else
                      collectECEOnLinelList=collectECEOnLinelList+","+collectECEOnLinelLists[m];
                   
                   }
                   collectECEOnLinelList = collectECEOnLinelList+","+row.get("trackingNumber");
               }
	        }
	        var selectGrid = Ext.getCmp("ECEOnLineSelectedGrid"+strInstructionSetExamination_ID);
	        selectGrid.condition.type = collectECEOnLinelList;
	        selectGrid.load();
	    }
        
        this.ECESelectedOnLineGrid.on({'rowdblclick':rowClickRemoveSelect});
        function rowClickRemoveSelect(grid,rowIndex, e)
        {
	        var row = grid.getSelectionModel().getSelected(); 
	        var collectECEOnLinelLists = collectECEOnLinelList.split(",");
	        var j = collectECEOnLinelLists.length;
	        for(var i=0;i < j;i++)
	        {
		        if(collectECEOnLinelLists[i]==row.get("trackingNumber"))
		        {
			          for(var t=i;t<j;t++)
			          {
			          collectECEOnLinelLists[t]=collectECEOnLinelLists[t+1];
			          }
			          j=j-1;
		        }
	        }
	        if(j==0)collectECEOnLinelList = "";
	        else
		    {
			    for(var m=0;m<j;m++)
			    {
			       if(m==0)collectECEOnLinelList=collectECEOnLinelLists[m];
			       else
			       collectECEOnLinelList=collectECEOnLinelList+","+collectECEOnLinelLists[m];
			    }
		    } 
	        grid.condition.type = collectECEOnLinelList;
	        grid.load();
	    }
        
         this.ECEOnLineListPanel = new Ext.FormPanel({
		        id: 'ECEOnLineListPanel'+strInstructionSetExamination_ID,
				region : 'center',
				width:500,
				height:550,
				layout: 'column',
				buttonAlign:'center',
				items: [{
		            columnWidth: 0.49,
		            layout: 'fit',
		            width:300,
				    height:505,
		            items:[this.selectECEOnLineGrid]
	               },
		            {
		            columnWidth: 0.02,
		            width:300,
				    height:505,
		            layout: 'fit'
		           },
		            {
		        	columnWidth: 0.49,
		            width:300,
				    height:505,
		            title:'已选取的实验申请单',
		            items:[this.ECESelectedOnLineGrid]
		            }]  
		 });
        
         this.showECEOnLineWindow = function(){
             var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
	         var strCommander_FK = record.get("responsible_FK");
	         if(loginUser != strCommander_FK)
	         {
	         	Ext.Msg.alert('温馨提示：', '您没有权限修改别人的指令');
                return;
             }else
             {
			     if (!this.ECEOnLineListWindow) {
                       this.ECEOnLineListWindow = new Ext.Window({
							id:'winECEOnLineList'+strInstructionSetExamination_ID,
			                layout:'fit',
			                title:'实验申请单选择',
			                width: 600,
			                height:580,
			                closeAction:'hide',
			                plain: true,
			                closable:false,
			                buttonAlign:'center',
							items: this.ECEOnLineListPanel,
						    buttons: [{
			                    text:'确定',
			                    disabled:false,
			                    handler: save.createDelegate(this)
			                },{
			                    text:'删除所有',
			                    disabled:false,
			                    hidden:true,
			                    handler: removeAll.createDelegate(this)
			                },{
			                    text: '关闭',
			                    handler: function(){
			                    var window = Ext.getCmp("winECEOnLineList"+strInstructionSetExamination_ID);
			                    window.hide();
			                    }
			                }]
			            });
			      }
			      this.selectECEOnLineGrid.condition.type="onLine";
	              this.selectECEOnLineGrid.load({params:{start:0, limit:20}});
	              collectECEOnLinelList = getDetailList(strInstructionSetExamination_ID,"onLine");
	              this.ECESelectedOnLineGrid.condition.type=collectECEOnLinelList;
	              this.ECESelectedOnLineGrid.load();
	              this.ECEOnLineListWindow.show();
	         }
		 };	
      
      this.instructionSetExamination_FK = strInstructionSetExamination_ID;
      this.condition = {}; 
      this.cm = new Ext.grid.ColumnModel([
             new Ext.grid.RowNumberer(),
			 {  header:"实验申请单",	
				dataIndex:"engineeringExperimentNumber",										
				sortable:true,
				width:window.document.body.clientWidth/5.1
			 },{
			    header:"结案报告",	
				dataIndex:"experimentEndReportNumber",										
				sortable:true,
				width:window.document.body.clientWidth/5.1
			 },{
			    header:"附件名称",	
				dataIndex:"fileName",										
				sortable:true,
				renderer:renderUrl,
				width:window.document.body.clientWidth/5.1
			 },
			 { dataIndex:"mark",width:window.document.body.clientWidth/25,renderer:renderDelete}
	  ]);
	  
	  var strCommander_FK = record.get("responsible_FK");
      function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
      {
        if( <%= objAction.getBooleanFlag("3") ? "true" : "false"%>)
        {
            var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
            var delegater = '<%=strDelegater%>';
	        if(loginUser == strCommander_FK || strCommander_FK == delegater)
	        {
            	return "<img  onclick=\"voidRequisition('"+record.data["instructionBodyOnlineExamination_ID"]+"','" + strInstructionSetExamination_ID + "','OnLine');\""+
			             " src='./images/dcc/cross.gif' />";
			}else{
			    return;
			}
	    }else if( <%= (nOrderTask==objAction.TASK_AdminConfirming)&&bHasToken ? "true" : "false"%>)
	    {
	        return "<img  onclick=\"voidRequisition('"+record.data["instructionBodyOnlineExamination_ID"]+"','" + strInstructionSetExamination_ID + "','OnLine');\""+
			             " src='./images/dcc/cross.gif' />";
	    }else{
	    	return;
	    }
      }
      
      function renderUrl(value, cellmeta, record, rowIndex, columnIndex, store)
      {
            return "<a href=\"" +"<%=objAction.getFileUpLoadURL()%>" + "DccProcessFileDLDownloadServlet?accessCode=" + record.data["attachmentBase"]+"&orderTask="+'<%=nOrderTask%>'+"\" target='_blank'>"+value+"</a>";
      }
	  
	  Ext.DomQuery.select("div.detailData")[0];  
	  this.store = new Ext.data.Store({
		    baseParams: this.condition, 
	        proxy: new Ext.data.HttpProxy(
			{method: 'POST',  
			url:'ECEsubOrderSet.do'}),
	        reader: new Ext.data.JsonReader({
				 totalProperty: 'totalProperty',
				 root: 'root'
				}, [
				{name:'instructionBodyOnlineExamination_ID'},
				{name: 'engineeringExperimentNumber'},
				{name: 'experimentEndReportNumber'},
				{name: 'fab_FK'},
				{name: 'attachment_ID'},
			    {name: 'attachmentBase'},
                {name: 'fileName'},
				{name:'mark'}
	        ]),
	        remoteSort:true 
      });    
	  
	  InstructionSetBodyOnlineGrid.superclass.constructor.call(this, {
	        id:strInstructionSetExamination_ID,
	        ds: this.store,
	        cm: this.cm,
	        renderTo:Ext.DomQuery.select("div.detailData",body)[0],
	        //autoWidth:true,
	        //autoHeight:true,
	        /*********自己定义格式1**********/
	        autoHeight:true,
	        width:window.document.body.clientWidth/1.55,
	        trackMouseOver:false, 
	        loadMask: {msg:'正在加载数据，请稍侯……'},
	        height:150,
	        viewConfig: {forceFit: false},
	        /****************************/
	        tbar:[{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '查看申请单',
	            iconCls:'agree',
	            anchor:'20%',
	            handler:function()
	            {
	                var grid=Ext.getCmp(strInstructionSetExamination_ID);
	            	var row = grid.getSelectionModel().getSelected(); 
				    if(row) 
					{
							var fab_FK = row.get("fab_FK");
							if( fab_FK == "KS1A" )
							{
								window.open(window.base + "/pages/pp/ArrayEngineeringExperiment.jsp?trackingNumber=" + row.get("engineeringExperimentNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
							}else if( fab_FK == "KS1B" )
							{
								window.open(window.base + "/pages/pp/CellEngineeringExperiment.jsp?trackingNumber=" + row.get("engineeringExperimentNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
							}else if( fab_FK == "KS1C" )
							{
								window.open(window.base + "/pages/pp/ModuleEngineeringExperiment.jsp?trackingNumber=" + row.get("engineeringExperimentNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
							}
						 	
					}else{
				    		Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
				    }
	            }
	        },{
	            text: '查看结案报告',
	            iconCls:'agree',
	            anchor:'20%',
	            handler:function()
	            {
	                var grid=Ext.getCmp(strInstructionSetExamination_ID);
	            	var row = grid.getSelectionModel().getSelected(); 
				    if(row) 
					{
						if(row.get("experimentEndReportNumber")=="")
						{
						        Ext.Msg.alert('温馨提示','该实验申请单没有相应地结案报告!');
						        return;
						}else{
						     	window.open(window.base + "/pages/pp/ExperimentEndReport.jsp?trackingNumber=" + row.get("experimentEndReportNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
						}
					}else{
				    		Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
					}
	            }
	        },{
	            text: '添加附件',
	            iconCls:'add',
	            tooltip:'添加OnLine附件',
	            hidden:<%=objAction.getBooleanFlag("3")|| (nOrderTask==objAction.TASK_AdminConfirming)&&bHasToken ? "false" : "true"%>,
	            anchor:'20%',
	            handler:function()
	            {
	                 var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
			         var strCommander_FK = record.get("responsible_FK");
			         var delegater = '<%=strDelegater%>';
			         if(loginUser != strCommander_FK)
			         {
			            if(<%=(nOrderTask==objAction.TASK_AdminConfirming)&&bHasToken%>)
		                {
		                 	var strReturn_ID = getOnLineAttachment_FK(strInstructionSetExamination_ID);
		                    uploadWindow(strInstructionSetExamination_ID,strReturn_ID);
		                }else if( strCommander_FK == delegater ){
		                	var strReturn_ID = getOnLineAttachment_FK(strInstructionSetExamination_ID);
		                    uploadWindow(strInstructionSetExamination_ID,strReturn_ID);
		                }else{
				         	Ext.Msg.alert('温馨提示：', '您没有权限修改别人的指令');
			                return;
			            }
		             }else{
		                 var strReturn_ID = getOnLineAttachment_FK(strInstructionSetExamination_ID);
		                 uploadWindow(strInstructionSetExamination_ID,strReturn_ID);
	                 }
	            }
	        },{
	            text: '增加SWR',
	            iconCls:'add',
	            tooltip:'添加OnLine指令',
	            hidden:<%=objAction.getBooleanFlag("3") ? "false" : "true"%>,
	            anchor:'20%',
	            handler:this.showECEOnLineWindow.createDelegate(this, [true])
	        }]
	  });
	  
	  this.on("rowcontextmenu",function(grid,rowIndex,e)
	  {
	  		e.preventDefault();
	  		if(rowIndex<0)
	  		{
	  			return;
	  		}
	  		var treeMenu = new Ext.menu.Menu({
		  		items:[{
	                id:'rMenu1',
	                text:'查看实验申请单',
	                icon:'./images/btn/btnAccept__b.gif',
	                handler:function()
	                {
	               	    var row = grid.getSelectionModel().getSelected(); 
				        if(row) 
						{
							var fab_FK = row.get("fab_FK");
							if( fab_FK == "KS1A" )
							{
								window.open(window.base + "/pages/pp/ArrayEngineeringExperiment.jsp?trackingNumber=" + row.get("engineeringExperimentNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
							}else if( fab_FK == "KS1B" )
							{
								window.open(window.base + "/pages/pp/CellEngineeringExperiment.jsp?trackingNumber=" + row.get("engineeringExperimentNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
							}else if( fab_FK == "KS1C" )
							{
								window.open(window.base + "/pages/pp/ModuleEngineeringExperiment.jsp?trackingNumber=" + row.get("engineeringExperimentNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
							}
						 	
						}else{
				    		Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
						}
	                }
	            },{
	                id:'rMenu2',
	                text:'查看结案报告',
	                icon:'./images/btn/btnAccept__b.gif',
	                handler:function()
	                {
	                	var row = grid.getSelectionModel().getSelected(); 
				        if(row) 
						{
						    if(row.get("experimentEndReportNumber")=="")
						    {
						        Ext.Msg.alert('温馨提示','该实验申请单没有相应地结案报告!');
						        return;
						    }else{
						     	window.open(window.base + "/pages/pp/ExperimentEndReport.jsp?trackingNumber=" + row.get("experimentEndReportNumber"), "", "left=0, top=0, width=1012px, height=700px, scrollbars=1, resizable=1, menubar=0, location=0, status=0, toolbar=0, "); 
						    }
						}else{
				    		Ext.Msg.alert('温馨提示','请选中您要查看的单号!');
						}
	                }
	            }]
	        });
            
            treeMenu.showAt(e.getPoint());
	  });  
}
Ext.extend(InstructionSetBodyOnlineGrid, Ext.grid.GridPanel,{
    load:function(){
    this.condition.type = "onLine";
    this.condition.instructionSetExamination_ID = this.instructionSetExamination_FK;
    this.condition.orderNumber ='<%=objOrderMaster.getTrackingNumber()%>';
    this.store.load();
    }
});
/************************************************************************/
/************************************************************************/
var InstructionSetAttachmentGrid=function(strGrid_ID,strFileKey,body,record)
{
      this.key = strFileKey;
      this.condition = {}; 
      this.cm = new Ext.grid.ColumnModel([
             new Ext.grid.RowNumberer(),
		     { dataIndex: 'attachment_ID',hidden:true},
             { header:"附件名称",width: window.document.body.clientWidth/1.7,dataIndex: 'fileName',renderer:renderUrl,sortable:true},
             { dataIndex:"mark",width:window.document.body.clientWidth/25,renderer:renderDelete}
	  ]);
	  Ext.DomQuery.select("div.detailData")[0];  
	  this.store = new Ext.data.Store({
		    baseParams: this.condition, 
	        proxy: new Ext.data.HttpProxy(
			{method: 'POST',  
			url:'ecAttachment.do'}),
	        reader: new Ext.data.JsonReader({
				 totalProperty: 'totalProperty',
				 root: 'root'
				}, [
				{name: 'attachment_ID'},
			    {name: 'attachmentBase'},
                {name: 'fileName'},
                {name: 'size'},
                {name: 'mark'}
	        ]),
	        remoteSort:true 
      });    
	  this.store.load();

      var strCommander_FK = record.get("responsible_FK");
      function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) 
      {
        if( <%= (objAction.getBooleanFlag("3") ) ? "true" : "false"%>)
        {
            var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
            var delegater = '<%=strDelegater%>';
	        if(loginUser == strCommander_FK || strCommander_FK == delegater)
	        {
            	return "<img  onclick=\"deleteAttachment('"+record.data["attachment_ID"]+"','"+strGrid_ID+"');\""+
			    	   " src='./images/dcc/cross.gif' />";
			}else{
			    return;
			}
		}else if( <%= (nOrderTask==objAction.TASK_AdminConfirming)&&bHasToken ? "true" : "false"%>)
	    {
	        return "<img  onclick=\"deleteAttachment('"+record.data["attachment_ID"]+"','"+strGrid_ID+"');\""+
			    	   " src='./images/dcc/cross.gif' />";
	    }else{
	        return;
	    }
      }
      
      function renderUrl(value, cellmeta, record, rowIndex, columnIndex, store)
      {
          return "<a href=\"" +"<%=objAction.getFileUpLoadURL()%>" + "DccProcessFileDLDownloadServlet?accessCode=" + record.data["attachmentBase"]+"&orderTask="+'<%=nOrderTask%>'+"\" target='_blank'>"+value+"</a>";
      }
	  
	  InstructionSetAttachmentGrid.superclass.constructor.call(this, {
	        id:strGrid_ID,
	        ds: this.store,
	        cm: this.cm,
	        renderTo:Ext.DomQuery.select("div.detailData",body)[0],
	        //autoWidth:true,
	        //autoHeight:true,
	        /*********自己定义格式1**********/
	        autoHeight:true,
	        width:window.document.body.clientWidth/1.55,
	        trackMouseOver:false, 
	        loadMask: {msg:'正在加载数据，请稍侯……'},
	        height:150,
	        viewConfig: {forceFit: false},
	        /****************************/
	        tbar:[{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '',
	            anchor:'20%'
	        },{
	            text: '增加',
	            iconCls:'add',
	            tooltip:'增加附件',
	            hidden:<%=( objAction.getBooleanFlag("3") || (nOrderTask==objAction.TASK_AdminConfirming)&&bHasToken ) ? "false" : "true"%>,
	            anchor:'20%',
	            handler:function()
	            {
	              var loginUser = '<%=objAction.getUser().getEmployee_FK()%>';
	              var strCommander_FK = record.get("responsible_FK");
	              var delegater = '<%=strDelegater%>';
	              if(loginUser != strCommander_FK)
	              {
	                 if(<%=(nOrderTask==objAction.TASK_AdminConfirming)&&bHasToken%>)
	                 {
	                 	uploadWindow(strGrid_ID,strFileKey);
	                 }else if( strCommander_FK == delegater ) {
	                 	uploadWindow(strGrid_ID,strFileKey);
	                 }else{
	             	 	Ext.Msg.alert('温馨提示：', '您没有权限修改别人的指令');
                     	return;
                     }
                  }else
                  {
	                 uploadWindow(strGrid_ID,strFileKey);
	              }
	            }
	        }]
	  });	   
}
Ext.extend(InstructionSetAttachmentGrid, Ext.grid.GridPanel,{
    load:function(){
    this.condition.type = '<%=objOrderMaster.getTrackingNumber()%>';
    this.condition.fileKey = this.key;
    this.store.load();
    }
});
/************************************************************************/
/************************************************************************/
var SelectBomMaterialGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECBomMaterial.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'materialNumber'},
			{name: 'materialName'}
			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'成品料号', dataIndex:'materialNumber',width:140,sortable:true},
			{header:'料号品名', dataIndex:'materialName',width:170,sortable:true}
	]);
	SelectBomMaterialGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:320,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		tbar: [
            'Search: ', ' ',
            new Ext.app.SearchField({
                store: this.store,
                width:150
            })
        ],
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(SelectBomMaterialGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
var SelectBomProductVersionGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECBomProductVersion.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'productVersion'},
			{name: 'productVersionText'},
			{name:'altBom'}
			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'生产版本', dataIndex:'productVersion',width:100,sortable:true},
			{header:'版本说明', dataIndex:'productVersionText',width:210,sortable:true}
	]);
	SelectBomProductVersionGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:320,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		tbar: [
            'Search: ', ' ',
            new Ext.app.SearchField({
                store: this.store,
                width:150
            })
        ],
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(SelectBomProductVersionGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
var SelectBomItemComponentGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECBomComponent.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'bomComponent'},
			{name: 'bomComponentQuality'},
			{name: 'bomComponentName'}
			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
			new Ext.grid.RowNumberer(),
			{header:'零件料号', dataIndex:'bomComponent',width:140,sortable:true},
			{header:'零件名称', dataIndex:'bomComponentName',width:170,sortable:true}
	]);
	SelectBomItemComponentGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:320,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		tbar: [
            'Search: ', ' ',
            new Ext.app.SearchField({
                store: this.store,
                width:150
            })
        ],
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(SelectBomItemComponentGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
function openHistroy()
{
	    this.histroyGrid = new EngineeringChangeExaminationHistroyGrid("ECEHistroyGrid");
        this.histroyGrid.condition.type = "ECE";
        this.histroyGrid.condition.engineeringChangeExamination_ID = '<%=objOrder.getEngineeringChangeExamination_ID()%>' ;
        this.histroyGrid.load();
        this.histroyGrid.on({'rowdblclick':rowClickSelect});
        function rowClickSelect(grid,rowIndex, e) 
		{
		    var record = grid.getSelectionModel().getSelected();  
		    var strOrderMaster_ID = '<%=objOrderMaster.getOrderMaster_ID()%>';
            var strEngineeringChangeExaminationItem_ID = record.get("engineeringChangeExaminationItem_ID");
            window.open(window.base + "/pages/ec/EngineeringChangeExaminationHistroy.jsp?orderMaster_ID=" + strOrderMaster_ID +"&orderItem_ID=" + strEngineeringChangeExaminationItem_ID, "", "left=0, top=0, width=1012px, height=680px, scrollbars=1, resizable=1, menubar=1, location=0, status=0, toolbar=0, "); 
		    win.close();
		}
        
        var  win= new Ext.Window({
	            modal:true,  
	            title:"工程变更管理",
	            closable:true,   
	            width:330,      
	            height:450,   
	            resizable:true,   
	            closeAction :'hide',   
	            plain:true,   
	            autoScroll: false, 
	            autoHeight:true,  
	            items:[this.histroyGrid]
		});
		win.show();	
}
/************************************************************************/
/************************************************************************/
var EngineeringChangeExaminationHistroyGrid = function(strGrid_ID) {
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECHistroy.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'histroyNumber'},
			{name: 'engineeringChangeExaminationItem_ID'}			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
            new Ext.grid.RowNumberer(),
			{header:'验证历史', dataIndex:'histroyNumber',width:310,sortable:true}
	]);
	EngineeringChangeExaminationHistroyGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:320,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(EngineeringChangeExaminationHistroyGrid, Ext.grid.GridPanel, {
	load: function() {
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
var BomReportHeaderGrid = function(strGrid_ID,strMaterial_FK,strBusinessUnit_FK,strAltBom) {
    this.material_FK = strMaterial_FK;
    this.businessUnit_FK = strBusinessUnit_FK;
    this.altBom = strAltBom;
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECBomReport.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'oldMaterial'},
			{name: 'productVersion'},
			{name: 'businessUnit'},
			{name: 'bomQuality'},
			{name: 'bomUnit'},
			{name: 'bomStatus'},
			{name: 'bomText'}			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
            new Ext.grid.RowNumberer(),
            {header:'成品料号', dataIndex:'oldMaterial',width:100,sortable:true},
            {header:'版本', dataIndex:'productVersion',width:70,sortable:true},
            {header:'工厂', dataIndex:'businessUnit',width:190,sortable:true},
			{header:'数量', dataIndex:'bomQuality',width:70,sortable:true},
			{header:'单位', dataIndex:'bomUnit',width:80,sortable:true},
			{header:'状态', dataIndex:'bomStatus',width:80,sortable:true},
			{header:'描述', dataIndex:'bomText',width:250,sortable:true}
	]);
	BomReportHeaderGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		title:'BOM的Header',
		border: false,
		loadMask: true,
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:920,
		height:100,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(BomReportHeaderGrid, Ext.grid.GridPanel, {
	load: function() {
	    this.condition.type = "ECE";
	    this.condition.model = "header";
	    this.condition.material_FK = this.material_FK ;
	    this.condition.businessUnit_FK = this.businessUnit_FK;
	    this.condition.altBom = this.altBom;
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/************************************************************************/
var BomReportItemGrid = function(strGrid_ID,strMaterial_FK,strBusinessUnit_FK,strAltBom) {
    this.material_FK = strMaterial_FK;
    this.businessUnit_FK = strBusinessUnit_FK;
    this.altBom = strAltBom;
    this.condition = {}; 
	this.store = new Ext.data.Store({ 
	    baseParams: this.condition,  
		proxy: new Ext.data.HttpProxy(
		{method: 'POST',  
		url:'ECBomReport.do'}),
		reader: new Ext.data.JsonReader({
			 totalProperty: 'totalProperty',
			 root: 'root'
			}, [
			{name: 'bomComponent'},
			{name: 'bomItemDesc'},
			{name: 'bomItemQuality'},
			{name: 'bomItemUnit'},
			{name: 'bomItemAltGroup'}			
        ])
	});
    this.cm = new Ext.grid.ColumnModel([
            new Ext.grid.RowNumberer(),
			{header:'组件', dataIndex:'bomComponent',width:120,sortable:true},
			{header:'组件描述', dataIndex:'bomItemDesc',width:295,sortable:true},
			{header:'数量', dataIndex:'bomItemQuality',width:100,sortable:true},
			{header:'单位', dataIndex:'bomItemUnit',width:100,sortable:true},
			{header:'替代物料组', dataIndex:'bomItemAltGroup',width:295,sortable:true}
	]);
	BomReportItemGrid.superclass.constructor.call(this, {
	    id : strGrid_ID,
		region: 'center',
		border: false,
		loadMask: true,
		title:'BOM的Item',
		loadMask: {msg:'正在加载数据，请稍侯……'}, 
		cls: 'x-rb',
		width:920,
		height:500,
		viewConfig: {forceFit: true},
		ds: this.store,
		sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
		cm: this.cm,
		bbar: new Ext.PagingToolbar({
			pageSize: 20,
			store: this.store,
			displayInfo: true,
			displayMsg: ' {0}~{1} of {2}',
			emptyMsg: "No Record"
		})
	});
}

Ext.extend(BomReportItemGrid, Ext.grid.GridPanel, {
	load: function() {
	    this.condition.type = "ECE";
	    this.condition.model = "item";
	    this.condition.material_FK = this.material_FK ;
	    this.condition.businessUnit_FK = this.businessUnit_FK;
	    this.condition.altBom = this.altBom;
		this.store.load({params:{start:0, limit:20}});
	},
	setCondition: function(c) {
		this.condition = c;
	}
});
/************************************************************************/
/**************************CosignWindow.js*******************************/
var collectCosign = "";
var CosignWindow = function() {
	var objCosignSelect = new CosignSelect();
	var save = function(){
		if(collectCosign==""){
			Ext.Msg.alert('温馨提示：', '请选择征询的人员!');
			return;
		} else {
			if(document.getElementById("cosignMsg").value==""){
				Ext.Msg.alert('温馨提示：', '请在备注中写明您的意见!');
				return;
			}
			document.getElementById("actionComment").value = document.getElementById("cosignMsg").value;
			document.getElementById("cosignList").value = getCosignEmp(collectCosign);
			document.getElementById("opcode").value = "6";
			submitInformation("recosign");
			closeWindow();
		}
	};
	var removeAll = function(){
		collectCosign = "";
		objCosignSelect.condition.type = "";
		objCosignSelect.condition.documentType = "recosign";
		objCosignSelect.store.load();
	};
	var closeWindow = function(){
		var objCosignWindow = Ext.getCmp("winCosign");
		objCosignWindow.hide();
	};
	var tree = new Ext.tree.TreePanel({
		id:'tree-cosign',
		useArrows:true,
		autoScroll:true,
		width:250,
		height:369,
		loader: new Ext.tree.TreeLoader({dataUrl: '<%=request.getContextPath()%>/org.do?department_ID=10000000'})
	});
	var root = new Ext.tree.AsyncTreeNode({	text : 'IVO龙腾光电',draggable : false,id : '10000000'});
	tree.setRootNode(root);
	root.expand(false,true); 
	tree.on('dblclick', function(node){
		if(node.leaf==true){
			if(node.id =='<%=objAction.getUser().getEmployee_FK()%>'){
				Ext.Msg.alert('温馨提示：', '请原谅,您不能选择自己！');
				return ;
			}
			if(collectCosign==""){
				collectCosign = node.id;
			}else{
				var collectCosigns = collectCosign.split(",");
				var j = collectCosigns.length ;
				for(var i=0;i < j;i++){
					if(collectCosigns[i]==node.id){
						for(var t=i;t<j;t++){
							collectCosigns[t]=collectCosigns[t+1];
						}
						j=j-1;
					}
				}
				if(j==0){
					collectCosign = node.id;
				} else {
					for(var m=0;m<j;m++){
						if(m==0){
							collectCosign=collectCosigns[m];
						}else{
							collectCosign=collectCosign+","+collectCosigns[m];
						}
					}
					collectCosign = collectCosign+","+node.id;
				}
			}
			var grid=Ext.getCmp("selectCosign");
			var selectCosigns = grid.condition.type;
			if(selectCosigns==''||selectCosigns==undefined){
				grid.condition.type =collectCosign;
				grid.load();
			}else{
				collectCosign=selectCosigns+","+collectCosign;
				grid.condition.type =collectCosign;
				grid.load();
			}
		}else{
			Ext.Msg.alert('温馨提示：', '请您选择人员！');
		}
	});
	objCosignSelect.on({'rowdblclick':rowClickCosign});
	function rowClickCosign(grid,rowIndex, e) {
		var row = grid.getSelectionModel().getSelected();
		var grid=Ext.getCmp("selectCosign");
		var selectCosigns = grid.condition.type;
		var cCosign = selectCosigns.split(",");
		var j = cCosign.length;
		for(var i=0;i < j;i++){
			if(cCosign[i]==row.get("employee_ID")){
				for(var t=i;t<j;t++){
					cCosign[t]=cCosign[t+1];
				}
				j=j-1;
			}
		}
		if(j==0){
			cCosign = "";
		}else{
			for(var m=0;m<j;m++){
				if(m==0){
					collectCosign=cCosign[m];
				}else{
					collectCosign=collectCosign+","+cCosign[m];
				}
			}
		}
		grid.condition.type = collectCosign;
		grid.load();
	}
	var tabs = new Ext.TabPanel({
        renderTo: 'tabs',
        columnWidth: 0.49,
        width:250,
		height:400,
        activeTab: 0,
        frame: false,
        defaults:{autoHeight: true},
        items:[
            {contentEl:'ivo', title: '树状图',items:[tree]},
            {contentEl:'find', title: '快速查找', listeners: {activate: Tab_onActivate}}
        ]
    });
	this.objCosignPanel = new Ext.FormPanel({
		id: 'cosignPanel',
		region : 'center',
		width:500,
		height:400,
		layout: 'column',
		buttonAlign:'center',
		items: [tabs,{
			columnWidth: 0.02,
			width:30,
			height:400,
			layout: 'fit'
		},{
			columnWidth: 0.49,
			title:'征询意见人员',
			items:[objCosignSelect]
		}]
	});
	var form = new Ext.form.FormPanel({
		baseCls: 'x-plain',
		width: 500,
		height:130,
		defaultType: 'textfield',
		labelAlign: 'top',
		items: [{
			xtype: 'textarea',
			hideLabel: false,
			fieldLabel: '备注',
			allowBlank:false,
			id:'cosignMsg',
			name: 'cosignMsg',
			anchor: '100% -53'
		}]
	});
	CosignWindow.superclass.constructor.call(this, {
		id:'winCosign',
		title:'征询意见',
		layout:'form',
		width: 500,
		height:550,
		closeAction:'hide',
		plain: true,
		buttonAlign:'center',
		items:[this.objCosignPanel,form],
		buttons: [{
			text:'确定',
			disabled:false,
			handler: save.createDelegate(this)
		},{
			text:'删除所有',
			disabled:false,
			handler: removeAll.createDelegate(this)
		},{
			text: '关闭',
			disabled:false,
			handler: closeWindow.createDelegate(this)
		}]
	});
};
Ext.extend(CosignWindow, Ext.Window);
function Tab_onActivate(tab){
	document.getElementById("findTable").style.display = "";
}
var END_POINT="<%=request.getContextPath()%>/bfapp";
var buffalo = new Buffalo(END_POINT);
function search(){
	var keyword = document.getElementById("keyword").value;
	if ( keyword.length > 0) {
		buffalo.remoteCall("employeeService.searchForHtmlTable", [keyword], function(reply) {
	       document.getElementById("findDiv").innerHTML = reply.getResult()
	    });
    } else {
    	messagebox("Please key in keyword.");
    }
}

function Document_onMouseOver()
{
	var element = getElement();
	if(element){
		var objRow = element.parentElement; 
		//alert( "onmouseover:"+objRow.outerHTML );
		objRow.className = "DialogLineHover"; //
	}
}
function Document_onMouseOut()
{
	var element = getElement();
	if(element){
		var objRow = element.parentElement; 
		//alert( "onmouseout:"+objRow.outerHTML );
		objRow.className = "DialogLine"; //
	}
}
/************************************************************************/
/************************CosignSelect.js*********************************/
var CosignSelect = function()
{
         	this.condition = {}; 
		    this.cm = new Ext.grid.ColumnModel([
					new Ext.grid.RowNumberer(),
					{header:'员工工号', dataIndex:'employee_ID',width:80,sortable:true},
					{header:'员工名称', dataIndex:'employeeName',width:150}
			]);
			this.store = new Ext.data.Store({
				    baseParams: this.condition, 
				    proxy: new Ext.data.HttpProxy(
					{method: 'POST',  
					url:'dccSelectRefDoc.do'}),
			        reader: new Ext.data.JsonReader({
						 totalProperty: 'totalProperty',
						 root: 'root',
						id:'employee_ID'
						}, [
						{name: 'employee_ID'},
			            {name: 'employeeName'}
			        ])
		    });
            
            CosignSelect.superclass.constructor.call(this, {
				    id : 'selectCosign',
					region: 'center',
					border: false,
					loadMask: true,
					width:300,
					height:500,
					cls: 'x-rb',
					viewConfig: {forceFit: true},
					ds: this.store,
					sm: new Ext.grid.RowSelectionModel({singleSelect:true}),
					cm: this.cm
			});
};
Ext.extend(CosignSelect, Ext.grid.GridPanel, {
			load: function(c) {
			     this.condition.documentType = "recosign";
				this.store.load();
			},
			setCondition: function(c) {
				this.condition = c;
			},
			refresh:function(){
			this.condition.type = ""; 
			this.condition.documentType = "recosign";
			this.store.load();
			}
});
function addSelected(strValue, strText)
{
	if(strValue =='<%=objAction.getUser().getEmployee_FK()%>'){
		Ext.Msg.alert('温馨提示：', '请原谅,您不能选择自己！');
		return ;
	}else{
		var selectCosigns=Ext.getCmp("selectCosign").condition.type;
		var grid = Ext.getCmp("selectCosign");
		if(selectCosigns==''||selectCosigns==undefined){
			grid.condition.type =strValue;
			grid.load();
			collectCosign=strValue;
		}else{
			selectCosigns=selectCosigns+","+strValue;
			grid.condition.type =selectCosigns;
			grid.load();
			collectCosign=selectCosigns;
		}
	}
}
/************************************************************************/
/************************************************************************/
//ECE160上传 文件
  function uploadCusAttachment(strFileKye,strGrid)
  {
        var grid = Ext.getCmp(strGrid);
        var record = grid.getSelectionModel().getSelected(); 
        
        if( record.get("followUpName") == "00")
        {
            Ext.Msg.alert('温馨提示：','请先选择该客户的意见后，再决定是否需要上传记录!');
            return;
        }

        if( record.get("fileName") == "" )
        {
      		  var fileKey = strFileKye;
              var winCustomerAttachment = new Ext.Window({
	                layout:'fit',
	                width:500,
	                height:120,
	                closeAction:'hide',
	                plain: true,
	                items: new Ext.form.FormPanel({ 
						labelAlign: 'right', 
						id:'urgentFileForm',
						labelWidth: 70, 
						frame:true, 
						fileUpload: true,
						items: [{ 
							xtype: 'textfield', 
							fieldLabel: '上传附件', 
							name: 'fileName', 
							allowBlank:false,
							inputType: 'file',
							anchor:'90%'//文件类型 
						}], 
						buttons: [{ 
							text: '上传', 
							iconCls:'upload',
							handler: function() 
							{ 
								var fileForm = Ext.getCmp("urgentFileForm");
								var strAccessCode = "trackingNumber="+'<%=objOrderMaster.getTrackingNumber()%>'+"&ProcessInstance="+'<%=objOrderMaster.getProcessInstance()%>'+"&type=EC&fileKey="+fileKey;
				                if (fileForm.getForm().isValid())
				                {
				                	fileForm.form.submit({
					                     url : '<%=objAction.getFileUpLoadURL()%>' +'DccFileUploadServlet?'+strAccessCode,
					                     success : function()
					                     { 
						                     var attachGrid = Ext.getCmp(strGrid);
						                     attachGrid.load();
						                     winCustomerAttachment.close();
					                     },
					                     failure : function(form, action) 
					                     {
					                         Ext.Msg.alert('温馨提示：','上传失败!');
					                     },
					                     waitMsg : '正在上传，请稍后...'
					                });
				                }else{
				                	Ext.Msg.alert('信息','请先选择附件!');
				                }
							}
						}]
				    })
				});   
		    winCustomerAttachment.show();
       }else {
            Ext.Msg.alert('温馨提示：','该客户已经上传了回执记录，不能重复上传!');
            return;
       }
  }
/*********************EngineeringVerfierGrid.js**************************/
var EngineeringAbolishCosignGrid=function(strGrid_ID) {
	this.condition = {};
	this.cm = new Ext.grid.ColumnModel([
		{width:30, dateIndex:'mark',renderer:renderDelete,sortable:true},
		{header:'部门名称', dataIndex:'department_FK',width:410,sortable:true},
		{header:'部门主管', dataIndex:'deptHead_FK',width:410}
	]);

	this.store = new Ext.data.Store({
		baseParams: this.condition,
		proxy: new Ext.data.HttpProxy({method: 'POST', url:'cosignSelectDept.do'}),
		reader: new Ext.data.JsonReader({totalProperty: 'totalProperty',root: 'root',id:'cosignDept_ID'},
		[{name: 'cosignItemExamination_ID'},{name: 'department_FK'},{name: 'deptHead_FK'},{name: 'mark'}])
	});

	function renderDelete(value, cellmeta, record, rowIndex, columnIndex, store) {
		if(<%=((nOrderTask == 25)&&bHasToken || bSucFlag || (nOrderTask ==170)&&bHasToken) ? "true" : "false"%>) {
			return "<img  onclick=\"voidRequisition('"+record.data["cosignItemExamination_ID"]+"','"+strGrid_ID+"','abolishCosign');\""+
				" src='./images/dcc/cross.gif' />";
		} else {
			return ;
		}
	}

	EngineeringAbolishCosignGrid.superclass.constructor.call(this, {
		id : strGrid_ID,
		region: 'center',
		border: true,
		loadMask: true,
		viewConfig: {forceFit: true},
		width:831,
		autoHeight:true,
		ds: this.store,
		cm: this.cm,
		tbar:['<h1 class ="STYLE1">废止会签部门</h1>','->',{
				text: '添加',
				id : 'add',
				iconCls:'add',
				hidden :<%=((nOrderTask == 25)&&bHasToken || bSucFlag ||(nOrderTask ==170)&&bHasToken) ? "false" : "true"%>,
				handler:function() { 
					winAbolishCosign = new AbolishCosignDeptWindow( '<%=objEngineeringChangeExaminationItemLast.getDomain_ID()%>' );
					winAbolishCosign.show(this);
				}
			}]
	});
};
Ext.extend(EngineeringAbolishCosignGrid, Ext.grid.GridPanel, {
	load: function() {
		this.condition.engineeringChangeExamination_ID ='<%=objOrder.getEngineeringChangeExamination_ID()%>';
		this.condition.type ="ECE";
		this.store.load();
	}
});

/************************Chrome-Ext.form.DateField***************************/
Ext.override(Ext.menu.DateMenu,{  
        render : function(){  
           Ext.menu.DateMenu.superclass.render.call(this);  
           if(Ext.isGecko|| Ext.isSafari||Ext.isChrome){  
            this.picker.el.dom.childNodes[0].style.width = '178px';  
            this.picker.el.dom.style.width = '178px';  
            }  
        }  
});
</script>  


<!-- Script End -->
<body>
	<div id='view'></div>

	<div id="tabs">

    <div id="ivo">
      <div id="tree" style="height:330px;"></div>
    </div>

    <div id="find">
      <div id="findTable" style="height:330px;display:none;">
	      <table>
	        <tr>
	        	<td colspan="2">
	        		<input id="keyword" name="keyword" onkeydown="Input_onEnterClick( search );" />
	        		<input type="button" value="Search" onclick="search()">
	        	</td>
	        </tr>
	        <tr>
	        	<td colspan="2">
	        		<div id="findDiv"></div>
	        	</td>
	        </tr>
	    	</table>
      </div>
    </div>

		
  </div>
</body>
</html>